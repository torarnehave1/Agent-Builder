{
  "version": 3,
  "sources": ["../../../editable-template.js", "../../../index.js"],
  "sourceRoot": "/Users/torarnehave/Documents/GitHub/Agent-Builder/worker/.wrangler/tmp/deploy-DuDfvG",
  "sourcesContent": ["/**\n * Editable HTML Template for Vegvisr Agent Builder\n * \n * Contains ALL infrastructure: CSS + JS for login, edit mode, visibility,\n * navigation, markdown rendering, save-to-KG.\n * \n * Placeholders:\n *   {{TITLE}}            - Page title\n *   {{DESCRIPTION}}      - Page subtitle\n *   {{FOOTER_TEXT}}      - Footer text\n *   {{GRAPH_ID_DEFAULT}} - Fallback graph ID\n */\n\nexport const EDITABLE_HTML_TEMPLATE = `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1.0\" />\n  <meta name=\"template-version\" content=\"1.0.0\" />\n  <title>{{TITLE}}</title>\n\n  <!-- Marked for Markdown rendering -->\n  <script src=\"https://cdn.jsdelivr.net/npm/marked/marked.min.js\"><\\/script>\n\n  <style>\n/* Page background */\n    body {\n      margin: 0;\n      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, \"Apple Color Emoji\", \"Segoe UI Emoji\";\n      color: #fff;\n      background:\n        radial-gradient(circle at top, rgba(56,189,248,0.20), transparent 55%),\n        radial-gradient(circle at bottom, rgba(139,92,246,0.18), transparent 55%),\n        #0b1220;\n    }\n\n    /* Layout helpers */\n    .container { max-width: 1100px; margin: 0 auto; padding: 40px 16px; }\n    .mb-6 { margin-bottom: 24px; }\n    .mt-1 { margin-top: 4px; }\n    .mt-2 { margin-top: 8px; }\n    .mt-6 { margin-top: 24px; }\n    .space-y-5 > * + * { margin-top: 20px; }\n    .text-xs { font-size: 12px; }\n    .text-sm { font-size: 14px; }\n    .text-xl { font-size: 20px; }\n    .text-2xl { font-size: 24px; }\n    .text-3xl { font-size: 30px; }\n    .font-semibold { font-weight: 600; }\n    .tracking-tight { letter-spacing: -0.015em; }\n    .whitespace-nowrap { white-space: nowrap; }\n    .hidden { display: none !important; }\n    .overflow-auto { overflow: auto; }\n\n    /* Cards / UI */\n    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); }\n    .muted { color: rgba(255,255,255,0.72); }\n    .soft  { color: rgba(255,255,255,0.58); }\n    .btn { border:1px solid rgba(255,255,255,0.16); background: rgba(255,255,255,0.06); color: #fff; cursor: pointer; }\n    .btn:hover { background: rgba(255,255,255,0.10); }\n    .btnPrimary { border-color: rgba(56,189,248,0.40); background: rgba(56,189,248,0.16); }\n    .btnPrimary:hover { background: rgba(56,189,248,0.24); }\n    .btn:disabled { opacity: 0.45; cursor: not-allowed; }\n\n    .rounded-lg { border-radius: 10px; }\n    .rounded-2xl { border-radius: 16px; }\n    .rounded-3xl { border-radius: 20px; }\n\n    .p-4 { padding: 16px; }\n    .p-6 { padding: 24px; }\n    .px-3 { padding-left: 12px; padding-right: 12px; }\n    .py-2 { padding-top: 8px; padding-bottom: 8px; }\n\n    /* Flex/grid */\n    .flex { display: flex; }\n    .grid { display: grid; }\n    .gap-2 { gap: 8px; }\n    .gap-4 { gap: 16px; }\n    .gap-6 { gap: 24px; }\n    .flex-wrap { flex-wrap: wrap; }\n    .items-center { align-items: center; }\n    .items-start { align-items: flex-start; }\n    .justify-between { justify-content: space-between; }\n\n    @media (min-width: 768px) {\n      .md-grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }\n      .md-grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }\n      .md-text-2xl { font-size: 24px; }\n      .md-text-3xl { font-size: 30px; }\n    }\n\n    /* Pills */\n    .pill {\n      border:1px solid rgba(255,255,255,0.14);\n      background: rgba(255,255,255,0.05);\n      padding: 6px 10px;\n      border-radius: 999px;\n      font-size: 12px;\n      cursor: pointer;\n      user-select: none;\n      max-width: 260px;\n      overflow: hidden;\n      text-overflow: ellipsis;\n      white-space: nowrap;\n    }\n    .pill:hover { background: rgba(255,255,255,0.08); }\n    .pillActive { border-color: rgba(56,189,248,0.55); background: rgba(56,189,248,0.12); }\n\n    code { color: rgba(125, 211, 252, 0.95); }\n    pre { margin: 0; }\n\n    /* Debug / JSON panel */\n    .debugPanel {\n      margin-top: 16px;\n      padding: 16px;\n      border-radius: 16px;\n      background: rgba(0,0,0,0.30);\n      border: 1px solid rgba(255,255,255,0.10);\n      font-size: 12px;\n      overflow: auto;\n      max-height: 520px;\n      white-space: pre;\n    }\n\n    /* Node preview panel (UI look) */\n    .previewPanel {\n      margin-top: 16px;\n      padding: 16px;\n      border-radius: 16px;\n      background: rgba(255,255,255,0.05);\n      border: 1px solid rgba(255,255,255,0.10);\n    }\n    .previewPanel h1, .previewPanel h2, .previewPanel h3 { margin: 0.6em 0 0.4em; }\n    .previewPanel p { margin: 0.6em 0; line-height: 1.55; color: rgba(255,255,255,0.82); }\n    .previewPanel a { color: rgba(125, 211, 252, 0.95); }\n    .previewPanel hr { border: none; border-top: 1px solid rgba(255,255,255,0.12); margin: 14px 0; }\n    .previewPanel img { max-width: 100%; border-radius: 12px; border: 1px solid rgba(255,255,255,0.10); }\n    .previewPanel blockquote {\n      border-left: 4px solid rgba(255,255,255,0.25);\n      padding-left: 12px;\n      margin: 12px 0;\n      color: rgba(255,255,255,0.78);\n    }\n    .previewPanel table {\n      width: 100%;\n      border-collapse: collapse;\n      margin: 10px 0;\n      overflow: hidden;\n      border-radius: 12px;\n      border: 1px solid rgba(255,255,255,0.10);\n    }\n    .previewPanel th, .previewPanel td {\n      padding: 10px 12px;\n      border-bottom: 1px solid rgba(255,255,255,0.10);\n      vertical-align: top;\n    }\n    .previewPanel th { background: rgba(255,255,255,0.06); text-align: left; }\n    .previewPanel ul, .previewPanel ol { margin: 0.6em 0; padding-left: 1.5em; }\n    .previewPanel li { margin: 0.3em 0; line-height: 1.5; }\n    .previewPanel code {\n      background: rgba(0,0,0,0.3);\n      padding: 2px 6px;\n      border-radius: 4px;\n      font-size: 0.9em;\n    }\n    .previewPanel pre {\n      background: rgba(0,0,0,0.3);\n      padding: 12px;\n      border-radius: 8px;\n      overflow-x: auto;\n      margin: 10px 0;\n    }\n    .previewPanel pre code {\n      background: none;\n      padding: 0;\n    }\n\n    /* ========== FORM UI STYLES ========== */\n    .ui-form {\n      display: flex;\n      flex-direction: column;\n      gap: 20px;\n    }\n    .ui-form-title {\n      font-size: 1.5rem;\n      font-weight: 600;\n      margin-bottom: 8px;\n      color: #fff;\n    }\n    .ui-form-description {\n      color: rgba(255,255,255,0.7);\n      margin-bottom: 16px;\n      line-height: 1.5;\n    }\n    .ui-block {\n      background: rgba(255,255,255,0.04);\n      border: 1px solid rgba(255,255,255,0.08);\n      border-radius: 12px;\n      padding: 16px;\n    }\n    .ui-block-title {\n      font-size: 1.1rem;\n      font-weight: 600;\n      margin-bottom: 12px;\n      color: rgba(255,255,255,0.9);\n    }\n    .ui-field {\n      margin-bottom: 16px;\n    }\n    .ui-field:last-child {\n      margin-bottom: 0;\n    }\n    .ui-label {\n      display: block;\n      font-size: 0.9rem;\n      font-weight: 500;\n      margin-bottom: 6px;\n      color: rgba(255,255,255,0.85);\n    }\n    .ui-input, .ui-select, .ui-textarea {\n      width: 100%;\n      padding: 10px 14px;\n      background: rgba(0,0,0,0.3);\n      border: 1px solid rgba(255,255,255,0.15);\n      border-radius: 8px;\n      color: #fff;\n      font-size: 0.95rem;\n      box-sizing: border-box;\n    }\n    .ui-input:focus, .ui-select:focus, .ui-textarea:focus {\n      outline: none;\n      border-color: rgba(56,189,248,0.5);\n      box-shadow: 0 0 0 3px rgba(56,189,248,0.15);\n    }\n    .ui-input::placeholder, .ui-textarea::placeholder {\n      color: rgba(255,255,255,0.4);\n    }\n    .ui-select {\n      cursor: pointer;\n    }\n    .ui-select option {\n      background: #1a1a2e;\n      color: #fff;\n    }\n    .ui-textarea {\n      min-height: 100px;\n      resize: vertical;\n    }\n    .ui-checkbox-group, .ui-radio-group {\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n    }\n    .ui-checkbox-item, .ui-radio-item {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      cursor: pointer;\n    }\n    .ui-checkbox-item input, .ui-radio-item input {\n      width: 18px;\n      height: 18px;\n      accent-color: rgba(56,189,248,0.8);\n      cursor: pointer;\n    }\n    .ui-choice-grid {\n      display: grid;\n      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));\n      gap: 12px;\n    }\n    .ui-choice-card {\n      background: rgba(255,255,255,0.04);\n      border: 1px solid rgba(255,255,255,0.12);\n      border-radius: 10px;\n      padding: 14px;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n    .ui-choice-card:hover {\n      background: rgba(255,255,255,0.08);\n      border-color: rgba(56,189,248,0.3);\n    }\n    .ui-choice-card.selected {\n      background: rgba(56,189,248,0.12);\n      border-color: rgba(56,189,248,0.5);\n    }\n    .ui-choice-card-title {\n      font-weight: 600;\n      margin-bottom: 4px;\n    }\n    .ui-choice-card-desc {\n      font-size: 0.85rem;\n      color: rgba(255,255,255,0.6);\n    }\n    .ui-button {\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      padding: 12px 24px;\n      background: rgba(56,189,248,0.2);\n      border: 1px solid rgba(56,189,248,0.4);\n      border-radius: 10px;\n      color: #fff;\n      font-size: 1rem;\n      font-weight: 500;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n    .ui-button:hover {\n      background: rgba(56,189,248,0.3);\n    }\n    .ui-info-box {\n      background: rgba(56,189,248,0.1);\n      border: 1px solid rgba(56,189,248,0.25);\n      border-radius: 10px;\n      padding: 14px;\n      color: rgba(255,255,255,0.85);\n    }\n    .ui-warning-box {\n      background: rgba(251,191,36,0.1);\n      border: 1px solid rgba(251,191,36,0.25);\n      border-radius: 10px;\n      padding: 14px;\n      color: rgba(255,255,255,0.85);\n    }\n\n    /* ========== EDIT MODE STYLES ========== */\n    .edit-mode-toolbar {\n      display: flex;\n      gap: 10px;\n      margin-bottom: 16px;\n      padding: 12px;\n      background: rgba(139,92,246,0.1);\n      border: 1px solid rgba(139,92,246,0.3);\n      border-radius: 10px;\n      align-items: center;\n      flex-wrap: wrap;\n    }\n    .edit-mode-toolbar .status {\n      flex: 1;\n      font-size: 0.9rem;\n      color: rgba(255,255,255,0.7);\n    }\n    .edit-mode-toolbar .status.saving {\n      color: rgba(251,191,36,0.9);\n    }\n    .edit-mode-toolbar .status.saved {\n      color: rgba(74,222,128,0.9);\n    }\n    .edit-mode-toolbar .status.error {\n      color: rgba(248,113,113,0.9);\n    }\n    .btn-edit {\n      background: rgba(139,92,246,0.2);\n      border-color: rgba(139,92,246,0.4);\n    }\n    .btn-edit:hover {\n      background: rgba(139,92,246,0.3);\n    }\n    .btn-save {\n      background: rgba(74,222,128,0.2);\n      border-color: rgba(74,222,128,0.4);\n    }\n    .btn-save:hover {\n      background: rgba(74,222,128,0.3);\n    }\n    .btn-cancel {\n      background: rgba(248,113,113,0.2);\n      border-color: rgba(248,113,113,0.4);\n    }\n    .btn-cancel:hover {\n      background: rgba(248,113,113,0.3);\n    }\n\n    /* Editable labels */\n    .ui-label.editable {\n      cursor: pointer;\n      position: relative;\n      padding-right: 20px;\n    }\n    .ui-label.editable::after {\n      content: '\u270E';\n      position: absolute;\n      right: 0;\n      opacity: 0.4;\n      font-size: 0.8em;\n    }\n    .ui-label.editable:hover::after {\n      opacity: 1;\n    }\n    .ui-label-input {\n      width: 100%;\n      padding: 6px 10px;\n      background: rgba(139,92,246,0.15);\n      border: 1px solid rgba(139,92,246,0.4);\n      border-radius: 6px;\n      color: #fff;\n      font-size: 0.9rem;\n      font-weight: 500;\n      margin-bottom: 6px;\n    }\n    .ui-label-input:focus {\n      outline: none;\n      border-color: rgba(139,92,246,0.7);\n      box-shadow: 0 0 0 3px rgba(139,92,246,0.2);\n    }\n\n    /* Editable title */\n    .ui-form-title.editable {\n      cursor: pointer;\n      position: relative;\n      display: inline-block;\n      padding-right: 30px;\n    }\n    .ui-form-title.editable::after {\n      content: '\u270E';\n      position: absolute;\n      right: 0;\n      opacity: 0.4;\n      font-size: 0.6em;\n    }\n    .ui-form-title.editable:hover::after {\n      opacity: 1;\n    }\n    .ui-form-title-input {\n      width: 100%;\n      padding: 8px 12px;\n      background: rgba(139,92,246,0.15);\n      border: 1px solid rgba(139,92,246,0.4);\n      border-radius: 8px;\n      color: #fff;\n      font-size: 1.5rem;\n      font-weight: 600;\n      margin-bottom: 8px;\n    }\n\n    /* Edit mode highlight */\n    .edit-mode .ui-input,\n    .edit-mode .ui-select,\n    .edit-mode .ui-textarea {\n      border-color: rgba(139,92,246,0.3);\n    }\n    .edit-mode .ui-input:focus,\n    .edit-mode .ui-select:focus,\n    .edit-mode .ui-textarea:focus {\n      border-color: rgba(139,92,246,0.6);\n      box-shadow: 0 0 0 3px rgba(139,92,246,0.15);\n    }\n\n    /* Add field button */\n    .btn-add-field {\n      display: inline-flex;\n      align-items: center;\n      gap: 6px;\n      padding: 8px 14px;\n      background: rgba(255,255,255,0.05);\n      border: 1px dashed rgba(255,255,255,0.2);\n      border-radius: 8px;\n      color: rgba(255,255,255,0.6);\n      font-size: 0.9rem;\n      cursor: pointer;\n      transition: all 0.2s;\n      margin-top: 12px;\n    }\n    .btn-add-field:hover {\n      background: rgba(255,255,255,0.08);\n      border-color: rgba(255,255,255,0.3);\n      color: rgba(255,255,255,0.8);\n    }\n\n    /* Delete field button */\n    .btn-delete-field {\n      position: absolute;\n      top: 0;\n      right: 0;\n      width: 24px;\n      height: 24px;\n      background: rgba(248,113,113,0.2);\n      border: 1px solid rgba(248,113,113,0.3);\n      border-radius: 6px;\n      color: rgba(248,113,113,0.8);\n      font-size: 14px;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      transition: opacity 0.2s;\n    }\n    .ui-field:hover .btn-delete-field {\n      opacity: 1;\n    }\n    .btn-delete-field:hover {\n      background: rgba(248,113,113,0.3);\n    }\n    .ui-field.edit-mode-field {\n      position: relative;\n      padding-right: 30px;\n    }\n\n    /* Edit mode user info */\n    #editUserInfo {\n      margin-left: auto;\n      margin-right: 8px;\n      color: rgba(255,255,255,0.5);\n    }\n\n    /* Login Modal */\n    .login-modal-overlay {\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0,0,0,0.7);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 1000;\n    }\n    .login-modal {\n      background: #1a1a2e;\n      border: 1px solid rgba(255,255,255,0.15);\n      border-radius: 16px;\n      padding: 32px;\n      max-width: 400px;\n      width: 90%;\n      box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n    }\n    .login-modal h2 {\n      margin: 0 0 8px 0;\n      font-size: 1.5rem;\n      color: #fff;\n    }\n    .login-modal p {\n      color: rgba(255,255,255,0.7);\n      margin: 0 0 20px 0;\n      font-size: 0.95rem;\n      line-height: 1.5;\n    }\n    .login-modal .form-group {\n      margin-bottom: 16px;\n    }\n    .login-modal label {\n      display: block;\n      margin-bottom: 6px;\n      color: rgba(255,255,255,0.85);\n      font-size: 0.9rem;\n    }\n    .login-modal input {\n      width: 100%;\n      padding: 12px 14px;\n      background: rgba(0,0,0,0.3);\n      border: 1px solid rgba(255,255,255,0.2);\n      border-radius: 8px;\n      color: #fff;\n      font-size: 1rem;\n      box-sizing: border-box;\n    }\n    .login-modal input:focus {\n      outline: none;\n      border-color: rgba(56,189,248,0.5);\n      box-shadow: 0 0 0 3px rgba(56,189,248,0.15);\n    }\n    .login-modal .btn-group {\n      display: flex;\n      gap: 10px;\n      margin-top: 20px;\n    }\n    .login-modal .btn-primary {\n      flex: 1;\n      padding: 12px 20px;\n      background: rgba(56,189,248,0.2);\n      border: 1px solid rgba(56,189,248,0.4);\n      border-radius: 8px;\n      color: #fff;\n      font-size: 1rem;\n      cursor: pointer;\n    }\n    .login-modal .btn-primary:hover {\n      background: rgba(56,189,248,0.3);\n    }\n    .login-modal .btn-primary:disabled {\n      opacity: 0.5;\n      cursor: not-allowed;\n    }\n    .login-modal .btn-secondary {\n      padding: 12px 20px;\n      background: rgba(255,255,255,0.06);\n      border: 1px solid rgba(255,255,255,0.16);\n      border-radius: 8px;\n      color: #fff;\n      font-size: 1rem;\n      cursor: pointer;\n    }\n    .login-modal .btn-secondary:hover {\n      background: rgba(255,255,255,0.10);\n    }\n    .login-modal .login-status {\n      margin-top: 12px;\n      padding: 10px;\n      border-radius: 8px;\n      font-size: 0.9rem;\n    }\n    .login-modal .login-status.info {\n      background: rgba(56,189,248,0.1);\n      border: 1px solid rgba(56,189,248,0.25);\n      color: rgba(255,255,255,0.85);\n    }\n    .login-modal .login-status.success {\n      background: rgba(74,222,128,0.1);\n      border: 1px solid rgba(74,222,128,0.25);\n      color: rgba(74,222,128,0.9);\n    }\n    .login-modal .login-status.error {\n      background: rgba(248,113,113,0.1);\n      border: 1px solid rgba(248,113,113,0.25);\n      color: rgba(248,113,113,0.9);\n    }\n\n    /* User info display */\n    .user-info {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      padding: 6px 12px;\n      background: rgba(255,255,255,0.06);\n      border: 1px solid rgba(255,255,255,0.12);\n      border-radius: 8px;\n      font-size: 0.85rem;\n      color: rgba(255,255,255,0.8);\n    }\n    .user-info .role-badge {\n      padding: 2px 8px;\n      background: rgba(139,92,246,0.2);\n      border: 1px solid rgba(139,92,246,0.4);\n      border-radius: 4px;\n      font-size: 0.75rem;\n      color: rgba(139,92,246,0.9);\n      text-transform: uppercase;\n    }\n\n    /* Vegvisr special elements CSS */\n    .work-note {\n      background-color: #ffd580;\n      color: #333;\n      font-size: 14px;\n      font-family: 'Courier New', Courier, monospace;\n      font-weight: bold;\n      padding: 10px;\n      margin: 10px 0;\n      border-left: 5px solid #ccc;\n      border-radius: 4px;\n    }\n    .work-note cite {\n      display: block;\n      text-align: right;\n      font-style: normal;\n      color: #666;\n      margin-top: 0.5em;\n    }\n    .fancy-quote {\n      font-style: italic;\n      background-color: #f9f9f9;\n      border-left: 5px solid #ccc;\n      font-size: 1.2em;\n      padding: 1em;\n      margin: 1em 0;\n      color: #333;\n      font-family: Arial, Helvetica, sans-serif;\n      border-radius: 8px;\n    }\n    .fancy-quote cite {\n      display: block;\n      text-align: right;\n      font-style: normal;\n      color: #666;\n      margin-top: 0.5em;\n    }\n    .section {\n      padding: 15px;\n      margin: 15px 0;\n      border-radius: 8px;\n      box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n      box-sizing: border-box;\n      background: rgba(255,255,255,0.06);\n      border: 1px solid rgba(255,255,255,0.10);\n      color: rgba(255,255,255,0.85);\n    }\n    .fancy-title {\n      background-size: cover;\n      background-position: center;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);\n      font-weight: bold;\n      border-radius: 8px;\n      overflow: hidden;\n      min-height: 120px;\n      padding: 20px;\n    }\n    .imagequote-element {\n      margin: 2em 0;\n      border-radius: 12px;\n      min-height: 200px;\n      display: flex;\n      flex-direction: column;\n      justify-content: center;\n      align-items: center;\n      text-align: center;\n      position: relative;\n      overflow: hidden;\n      color: white;\n      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7);\n      background-size: cover;\n      background-position: center;\n    }\n    .imagequote-element::before {\n      content: '';\n      position: absolute;\n      inset: 0;\n      background: rgba(0, 0, 0, 0.3);\n      z-index: 1;\n    }\n    .imagequote-content {\n      position: relative;\n      z-index: 2;\n      font-size: 1.5rem;\n      font-weight: 600;\n      line-height: 1.4;\n      max-width: 80%;\n    }\n    .imagequote-citation {\n      position: relative;\n      z-index: 2;\n      margin-top: 1em;\n      font-size: 1rem;\n      font-style: italic;\n      opacity: 0.9;\n    }\n\n    /* ========== YOUTUBE EMBED STYLES ========== */\n    .youtube-embed-container {\n      position: relative;\n      width: 100%;\n      padding-bottom: 56.25%; /* 16:9 aspect ratio */\n      height: 0;\n      overflow: hidden;\n      border-radius: 12px;\n      background: rgba(0, 0, 0, 0.3);\n      border: 1px solid rgba(255, 255, 255, 0.1);\n    }\n    .youtube-embed-container iframe {\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      border: none;\n      border-radius: 12px;\n    }\n    .youtube-video-info {\n      margin-top: 16px;\n      padding: 16px;\n      background: rgba(255, 255, 255, 0.04);\n      border: 1px solid rgba(255, 255, 255, 0.08);\n      border-radius: 10px;\n    }\n    .youtube-video-info p {\n      margin: 0 0 8px 0;\n      color: rgba(255, 255, 255, 0.8);\n      line-height: 1.5;\n    }\n    .youtube-video-info p:last-child {\n      margin-bottom: 0;\n    }\n    .youtube-video-link {\n      display: inline-flex;\n      align-items: center;\n      gap: 6px;\n      margin-top: 12px;\n      padding: 8px 14px;\n      background: rgba(255, 0, 0, 0.1);\n      border: 1px solid rgba(255, 0, 0, 0.3);\n      border-radius: 8px;\n      color: #ff4444;\n      text-decoration: none;\n      font-size: 0.9rem;\n      transition: all 0.2s;\n    }\n    .youtube-video-link:hover {\n      background: rgba(255, 0, 0, 0.2);\n      border-color: rgba(255, 0, 0, 0.5);\n    }\n    .youtube-video-link svg {\n      width: 18px;\n      height: 18px;\n      fill: currentColor;\n    }\n    .youtube-error {\n      padding: 24px;\n      background: rgba(248, 113, 113, 0.1);\n      border: 1px solid rgba(248, 113, 113, 0.3);\n      border-radius: 12px;\n      color: rgba(255, 255, 255, 0.8);\n      text-align: center;\n    }\n    .youtube-error code {\n      display: block;\n      margin-top: 8px;\n      font-size: 0.85rem;\n      color: rgba(255, 255, 255, 0.6);\n    }\n\n    /* YouTube Edit Mode Styles */\n    .youtube-edit-form {\n      display: flex;\n      flex-direction: column;\n      gap: 16px;\n    }\n    .youtube-edit-field {\n      display: flex;\n      flex-direction: column;\n      gap: 6px;\n    }\n    .youtube-edit-field label {\n      font-size: 0.9rem;\n      font-weight: 500;\n      color: rgba(255, 255, 255, 0.85);\n    }\n    .youtube-edit-field input,\n    .youtube-edit-field textarea {\n      width: 100%;\n      padding: 10px 14px;\n      background: rgba(139, 92, 246, 0.1);\n      border: 1px solid rgba(139, 92, 246, 0.3);\n      border-radius: 8px;\n      color: #fff;\n      font-size: 0.95rem;\n      box-sizing: border-box;\n    }\n    .youtube-edit-field input:focus,\n    .youtube-edit-field textarea:focus {\n      outline: none;\n      border-color: rgba(139, 92, 246, 0.6);\n      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);\n    }\n    .youtube-edit-field textarea {\n      min-height: 80px;\n      resize: vertical;\n    }\n    .youtube-edit-field .field-help {\n      font-size: 0.8rem;\n      color: rgba(255, 255, 255, 0.5);\n    }\n    .youtube-preview-small {\n      position: relative;\n      width: 100%;\n      max-width: 400px;\n      padding-bottom: 56.25%;\n      height: 0;\n      overflow: hidden;\n      border-radius: 8px;\n      background: rgba(0, 0, 0, 0.3);\n      border: 1px solid rgba(255, 255, 255, 0.1);\n    }\n    .youtube-preview-small iframe {\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      border: none;\n      border-radius: 8px;\n    }\n    .youtube-preview-placeholder {\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      color: rgba(255, 255, 255, 0.5);\n      font-size: 0.9rem;\n      text-align: center;\n      padding: 20px;\n      box-sizing: border-box;\n    }\n    .youtube-url-status {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      font-size: 0.85rem;\n      padding: 8px 12px;\n      border-radius: 6px;\n      margin-top: 8px;\n    }\n    .youtube-url-status.valid {\n      background: rgba(74, 222, 128, 0.1);\n      border: 1px solid rgba(74, 222, 128, 0.3);\n      color: rgba(74, 222, 128, 0.9);\n    }\n    .youtube-url-status.invalid {\n      background: rgba(248, 113, 113, 0.1);\n      border: 1px solid rgba(248, 113, 113, 0.3);\n      color: rgba(248, 113, 113, 0.9);\n    }\n\n    /* Fulltext Edit Form Styles */\n    .fulltext-edit-form {\n      display: flex;\n      flex-direction: column;\n      gap: 20px;\n    }\n    .fulltext-edit-field {\n      display: flex;\n      flex-direction: column;\n      gap: 6px;\n    }\n    .fulltext-edit-field label {\n      font-size: 0.9rem;\n      font-weight: 500;\n      color: rgba(255, 255, 255, 0.85);\n    }\n    .fulltext-textarea {\n      width: 100%;\n      padding: 12px 14px;\n      background: rgba(139, 92, 246, 0.1);\n      border: 1px solid rgba(139, 92, 246, 0.3);\n      border-radius: 8px;\n      color: #fff;\n      font-size: 0.95rem;\n      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;\n      box-sizing: border-box;\n      min-height: 200px;\n      resize: none;\n      line-height: 1.5;\n    }\n    .fulltext-textarea:focus {\n      outline: none;\n      border-color: rgba(139, 92, 246, 0.6);\n      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);\n    }\n    .fulltext-preview-field {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n    }\n    .fulltext-preview-field label {\n      font-size: 0.9rem;\n      font-weight: 500;\n      color: rgba(255, 255, 255, 0.85);\n    }\n\n    /* Header Image Styles */\n    .header-image-wrap {\n      position: relative;\n      margin-bottom: 24px;\n    }\n    .header-image {\n      width: 100%;\n      max-height: 400px;\n      border-radius: 16px;\n      border: 1px solid rgba(255, 255, 255, 0.1);\n      object-fit: cover;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\n    }\n    .header-image-edit {\n      position: absolute;\n      top: 12px;\n      right: 12px;\n      background: rgba(0,0,0,0.6);\n      border: 1px solid rgba(255,255,255,0.2);\n      border-radius: 8px;\n      padding: 6px 12px;\n      color: #fff;\n      font-size: 14px;\n      cursor: pointer;\n      backdrop-filter: blur(8px);\n      transition: all 0.2s;\n    }\n    .header-image-edit:hover {\n      background: rgba(139,92,246,0.5);\n      border-color: rgba(139,92,246,0.6);\n    }\n    .header-image-editor {\n      display: flex;\n      gap: 8px;\n      align-items: center;\n      margin-bottom: 16px;\n      padding: 12px;\n      background: rgba(255,255,255,0.04);\n      border: 1px solid rgba(255,255,255,0.1);\n      border-radius: 12px;\n    }\n    .header-image-input {\n      flex: 1;\n      padding: 8px 12px;\n      background: rgba(0,0,0,0.3);\n      border: 1px solid rgba(255,255,255,0.15);\n      border-radius: 8px;\n      color: #fff;\n      font-size: 13px;\n    }\n    .header-image-input:focus {\n      outline: none;\n      border-color: rgba(139,92,246,0.5);\n    }\n\n    header {\n      position: relative;\n    }\n\n    .header-content {\n      position: relative;\n      z-index: 1;\n    }\n\n    /* ========== ELEMENT VISIBILITY CONTROLS ========== */\n    .visibility-toggle {\n      position: absolute;\n      top: 8px;\n      right: 8px;\n      width: 32px;\n      height: 32px;\n      padding: 0;\n      background: rgba(139, 92, 246, 0.2);\n      border: 1px solid rgba(139, 92, 246, 0.4);\n      border-radius: 6px;\n      color: rgba(139, 92, 246, 0.9);\n      font-size: 18px;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: all 0.2s;\n      opacity: 0;\n      pointer-events: none;\n      z-index: 1000;\n    }\n\n    .visibility-toggle:hover {\n      background: rgba(139, 92, 246, 0.3);\n      border-color: rgba(139, 92, 246, 0.6);\n    }\n\n    .visibility-toggle.visible {\n      pointer-events: auto;\n      opacity: 1;\n    }\n\n    .controllable-element {\n      position: relative;\n      transition: opacity 0.3s ease;\n    }\n\n    .controllable-element:hover .visibility-toggle.visible {\n      opacity: 1;\n      pointer-events: auto;\n    }\n\n    .controllable-element.hidden-element {\n      opacity: 0.5;\n      pointer-events: none;\n    }\n\n    /* Ensure controllable elements have position relative for absolute positioning */\n    header.controllable-element,\n    div.controllable-element,\n    main.controllable-element {\n      position: relative;\n    }\n\n    .visibility-panel {\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      background: rgba(20, 30, 50, 0.95);\n      border: 1px solid rgba(139, 92, 246, 0.4);\n      border-radius: 12px;\n      padding: 16px;\n      max-width: 320px;\n      z-index: 999;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n      display: none;\n      flex-direction: column;\n      gap: 12px;\n    }\n\n    .visibility-panel.active {\n      display: flex;\n    }\n\n    .visibility-panel-title {\n      font-weight: 600;\n      color: #fff;\n      margin-bottom: 8px;\n      font-size: 0.95rem;\n    }\n\n    .visibility-item {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      padding: 8px;\n      background: rgba(255, 255, 255, 0.04);\n      border-radius: 8px;\n      cursor: pointer;\n    }\n\n    .visibility-item:hover {\n      background: rgba(255, 255, 255, 0.08);\n    }\n\n    .visibility-toggle-switch {\n      width: 40px;\n      height: 24px;\n      background: rgba(248, 113, 113, 0.3);\n      border: 1px solid rgba(248, 113, 113, 0.4);\n      border-radius: 12px;\n      position: relative;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n\n    .visibility-toggle-switch.on {\n      background: rgba(74, 222, 128, 0.3);\n      border-color: rgba(74, 222, 128, 0.4);\n    }\n\n    .visibility-toggle-switch::after {\n      content: '';\n      position: absolute;\n      width: 18px;\n      height: 18px;\n      background: rgba(255, 255, 255, 0.8);\n      border-radius: 10px;\n      top: 2px;\n      left: 2px;\n      transition: left 0.2s;\n    }\n\n    .visibility-toggle-switch.on::after {\n      left: 18px;\n    }\n\n    .visibility-item-label {\n      flex: 1;\n      font-size: 0.9rem;\n      color: rgba(255, 255, 255, 0.85);\n    }\n\n    .visibility-panel-actions {\n      display: flex;\n      gap: 8px;\n      margin-top: 8px;\n      padding-top: 8px;\n      border-top: 1px solid rgba(255, 255, 255, 0.1);\n    }\n\n    .visibility-panel-actions button {\n      flex: 1;\n      padding: 8px 12px;\n      font-size: 0.85rem;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      background: rgba(255, 255, 255, 0.06);\n      color: #fff;\n      border-radius: 6px;\n      cursor: pointer;\n    }\n\n    .visibility-panel-actions button:hover {\n      background: rgba(255, 255, 255, 0.1);\n    }\n\n    .visibility-panel-actions button.save {\n      background: rgba(74, 222, 128, 0.2);\n      border-color: rgba(74, 222, 128, 0.4);\n      color: rgba(74, 222, 128, 0.9);\n    }\n\n    .visibility-panel-actions button.save:hover {\n      background: rgba(74, 222, 128, 0.3);\n    }\n\n    /* ========== SIDEBAR NAVIGATION STYLES ========== */\n    /* Hamburger button (top-left, fixed) */\n    .hamburger-button {\n      position: fixed;\n      top: 20px;\n      left: 20px;\n      width: 40px;\n      height: 40px;\n      background: rgba(255,255,255,0.06);\n      border: 1px solid rgba(255,255,255,0.16);\n      border-radius: 1px;\n      cursor: pointer;\n      z-index: 999;\n      display: none; /* Hidden by default */\n      align-items: center;\n      justify-content: center;\n      transition: all 0.2s;\n    }\n\n    .hamburger-button:hover {\n      background: rgba(255,255,255,0.10);\n    }\n\n    .hamburger-button.active {\n      background: rgba(56,189,248,0.16);\n      border-color: rgba(56,189,248,0.40);\n    }\n\n    /* Hamburger icon (3 lines) */\n    .hamburger-icon {\n      width: 20px;\n      height: 14px;\n      position: relative;\n      display: flex;\n      flex-direction: column;\n      justify-content: space-between;\n    }\n\n    .hamburger-icon span {\n      width: 100%;\n      height: 2px;\n      background: rgba(255,255,255,0.85);\n      border-radius: 2px;\n      transition: all 0.3s;\n    }\n\n    /* Sidebar navigation container */\n    .sidebar-nav {\n      position: fixed;\n      top: 0;\n      left: -280px; /* Hidden by default */\n      width: 280px;\n      height: 100vh;\n      background: rgba(11, 18, 32, 0.98);\n      border-right: 1px solid rgba(255,255,255,0.12);\n      z-index: 998;\n      transition: left 0.3s ease;\n      overflow-y: auto;\n      padding: 80px 16px 20px 16px;\n      box-shadow: 2px 0 20px rgba(0,0,0,0.3);\n    }\n\n    .sidebar-nav.open {\n      left: 0;\n    }\n\n    /* Sidebar pills (vertical layout) */\n    .sidebar-nav .pill {\n      width: calc(100% - 16px);\n      max-width: none;\n      margin: 0 8px 8px 8px;\n      display: block;\n      text-align: left;\n    }\n\n    .sidebar-nav .text-sm {\n      margin-bottom: 12px;\n      padding-left: 4px;\n    }\n\n    /* Dimmed backdrop when sidebar is open */\n    .sidebar-backdrop {\n      position: fixed;\n      inset: 0;\n      background: transparent;\n      z-index: 997; /* below sidebar (998) and hamburger (999) */\n      opacity: 0;\n      pointer-events: none;\n      transition: opacity 0.25s ease;\n    }\n\n    body.sidebar-open .sidebar-backdrop {\n      opacity: 1;\n      pointer-events: auto;\n    }\n\n    /* Layout mode classes */\n    .nodes-layout-sidebar .card[data-element-id=\"nodesList\"] {\n      display: none !important; /* Hide the horizontal card */\n    }\n\n    .nodes-layout-sidebar .hamburger-button {\n      display: flex; /* Show hamburger button */\n    }\n\n\n/* NodeTitle override (added) */\n#nodeTitle {\n  color: blue !important;\n}\n\n    /* Navigation bar */\n    .nav-bar {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 12px;\n      padding: 16px 24px;\n      background: rgba(255,255,255,0.04);\n      border: 1px solid rgba(255,255,255,0.08);\n      border-radius: 16px;\n      backdrop-filter: blur(12px);\n      position: relative;\n    }\n    .nav-btn {\n      padding: 10px 24px;\n      border-radius: 10px;\n      border: 1px solid rgba(255,255,255,0.12);\n      background: rgba(255,255,255,0.06);\n      color: rgba(255,255,255,0.85);\n      font-size: 14px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n    .nav-btn:hover {\n      background: rgba(139,92,246,0.25);\n      border-color: rgba(139,92,246,0.4);\n    }\n    .nav-btn-primary {\n      background: rgba(139,92,246,0.3);\n      border-color: rgba(139,92,246,0.5);\n      color: #fff;\n    }\n    .nav-btn-primary:hover {\n      background: rgba(139,92,246,0.5);\n    }\n    .nav-btn-sm {\n      padding: 8px 16px;\n      font-size: 12px;\n      opacity: 0.7;\n    }\n    .nav-meta {\n      color: rgba(255,255,255,0.5);\n      font-size: 13px;\n      min-width: 120px;\n      text-align: center;\n    }\n\n  </style>\n</head>\n\n<body>\n  <!-- Hamburger Menu Button (visible only in sidebar mode) -->\n  <button type=\"button\" id=\"hamburgerButton\" class=\"hamburger-button\" title=\"Toggle navigation menu\">\n    <div class=\"hamburger-icon\">\n      <span></span>\n      <span></span>\n      <span></span>\n    </div>\n  </button>\n\n  <!-- Sidebar Navigation (visible only in sidebar mode) -->\n  <div id=\"sidebarNav\" class=\"sidebar-nav\">\n    <div class=\"text-sm soft\">Nodes:</div>\n    <div id=\"sidebarPills\"></div>\n  </div>\n  <div id=\"sidebarBackdrop\" class=\"sidebar-backdrop\" aria-hidden=\"true\"></div>\n\n  <div class=\"container\">\n    <header class=\"mb-6 controllable-element\" data-element-id=\"header\">\n      <button type=\"button\" class=\"visibility-toggle\" title=\"Toggle visibility\">\\u{1F441}\\uFE0F</button>\n      <div class=\"header-image-wrap\" id=\"headerImageWrap\">\n        <img src=\"\" alt=\"{{TITLE}} Header\" class=\"header-image\" id=\"headerImage\" style=\"display:none;\">\n        <button type=\"button\" class=\"header-image-edit hidden\" id=\"btnEditHeaderImage\" title=\"Change header image\">\\u270F\\uFE0F</button>\n      </div>\n      <div class=\"header-image-editor hidden\" id=\"headerImageEditor\">\n        <input type=\"text\" id=\"headerImageUrl\" class=\"header-image-input\" placeholder=\"Paste image URL here...\" />\n        <button type=\"button\" id=\"btnApplyHeaderImage\" class=\"nav-btn nav-btn-primary\" style=\"padding:8px 16px;font-size:13px;\">Apply</button>\n        <button type=\"button\" id=\"btnCancelHeaderImage\" class=\"nav-btn\" style=\"padding:8px 16px;font-size:13px;\">Cancel</button>\n      </div>\n      <div class=\"header-content\">\n        <h1 class=\"text-2xl md-text-3xl font-semibold tracking-tight\">{{TITLE}}</h1>\n        <p class=\"muted mt-2\">\n          {{DESCRIPTION}}\n        </p>\n      </div>\n    </header>\n\n    <div class=\"grid md-grid-cols-2 gap-4 mb-6 controllable-element\" data-element-id=\"stats\">\n      <button type=\"button\" class=\"visibility-toggle\" title=\"Toggle visibility\">\\u{1F441}\\uFE0F</button>\n      <div class=\"card rounded-2xl p-4\">\n        <div class=\"text-sm soft\">Graph ID</div>\n        <div class=\"mt-1 font-semibold\" id=\"graphIdLabel\">\\u2014</div>\n        <div class=\"text-xs soft mt-1\">Data source: <code>https://knowledge.vegvisr.org/getknowgraph?id=\\u2026</code></div>\n      </div>\n\n      <div class=\"card rounded-2xl p-4\">\n        <div class=\"text-sm soft\">Nodes loaded</div>\n        <div class=\"mt-1 font-semibold\" id=\"discoveredCount\">\\u2014</div>\n        <div class=\"text-xs soft mt-1\">Filter: label contains <code>#</code></div>\n      </div>\n    </div>\n\n    <div class=\"card rounded-2xl p-4 mb-6 controllable-element\" data-element-id=\"nodesList\">\n      <button type=\"button\" class=\"visibility-toggle\" title=\"Toggle visibility\">\\u{1F441}\\uFE0F</button>\n      <div class=\"flex flex-wrap gap-2 items-center\">\n        <div class=\"text-sm soft\" style=\"margin-right:8px;\">Nodes:</div>\n        <div id=\"stepPills\" class=\"flex flex-wrap gap-2\"></div>\n      </div>\n    </div>\n\n    <main class=\"card rounded-3xl p-6 controllable-element\" data-element-id=\"mainContent\">\n      <button type=\"button\" class=\"visibility-toggle\" title=\"Toggle visibility\">\\u{1F441}\\uFE0F</button>\n      <div class=\"flex items-start justify-between gap-4\">\n        <div>\n          <div class=\"text-sm soft\" id=\"nodeMeta\">\\u2014</div>\n          <h2 class=\"text-xl md-text-2xl font-semibold mt-1\" id=\"nodeTitle\">\\u2014</h2>\n          <div class=\"muted mt-2\" id=\"nodeIntro\"></div>\n        </div>\n        <div class=\"flex gap-2 flex-wrap\">\n          <button type=\"button\" id=\"btnLogin\" class=\"btn rounded-lg px-3 py-2 text-sm whitespace-nowrap\">Login</button>\n          <button type=\"button\" id=\"btnLogout\" class=\"btn btn-cancel rounded-lg px-3 py-2 text-sm whitespace-nowrap hidden\">Logout</button>\n          <button id=\"btnEditMode\" class=\"btn btn-edit rounded-lg px-3 py-2 text-sm whitespace-nowrap hidden\">Edit Mode</button>\n          <button id=\"btnToggleView\" class=\"btn btnPrimary rounded-lg px-3 py-2 text-sm whitespace-nowrap hidden\">Show JSON</button>\n          <button id=\"btnToggleDebug\" class=\"btn rounded-lg px-3 py-2 text-sm whitespace-nowrap hidden\">Debug</button>\n        </div>\n      </div>\n\n      <!-- Edit mode toolbar (hidden by default, only for Superadmin) -->\n      <div id=\"editToolbar\" class=\"edit-mode-toolbar hidden\">\n        <div class=\"status\" id=\"editStatus\">Edit mode: Click labels to rename, modify values, then save.</div>\n        <div class=\"text-xs soft\" id=\"editUserInfo\"></div>\n        <button type=\"button\" id=\"btnSaveNode\" class=\"btn btn-save rounded-lg px-3 py-2 text-sm whitespace-nowrap\">Save</button>\n        <button type=\"button\" id=\"btnCancelEdit\" class=\"btn btn-cancel rounded-lg px-3 py-2 text-sm whitespace-nowrap\">Cancel</button>\n      </div>\n\n      <!-- UI preview -->\n      <div id=\"uiView\" class=\"previewPanel mt-6\">\n        <div id=\"nodePreview\"></div>\n      </div>\n\n      <!-- JSON view -->\n      <pre id=\"jsonView\" class=\"hidden debugPanel\"></pre>\n\n      <!-- Debug view -->\n      <pre id=\"debug\" class=\"hidden debugPanel\"></pre>\n    </main>\n\n    <nav class=\"nav-bar mt-6 controllable-element\" data-element-id=\"navigation\">\n      <button type=\"button\" class=\"visibility-toggle\" title=\"Toggle visibility\">\\u{1F441}\\uFE0F</button>\n      <button id=\"btnPrev\" class=\"nav-btn\">\\u2190 Back</button>\n      <span class=\"nav-meta\" id=\"nodeMeta2\"></span>\n      <button id=\"btnNext\" class=\"nav-btn nav-btn-primary\">Next \\u2192</button>\n      <button id=\"btnReload\" class=\"nav-btn nav-btn-sm\">Reload</button>\n    </nav>\n\n    <footer class=\"soft text-xs mt-6\">\n      {{FOOTER_TEXT}}\n    </footer>\n  </div>\n\n  <!-- Visibility Control Panel (only visible to Superadmins) -->\n  <div id=\"visibilityPanel\" class=\"visibility-panel\">\n    <div class=\"visibility-panel-title\">Element Visibility</div>\n    <div id=\"visibilityItems\" class=\"visibility-items\"></div>\n    <div class=\"visibility-panel-actions\">\n      <button type=\"button\" id=\"btnSaveVisibility\" class=\"save\">Save</button>\n      <button type=\"button\" id=\"btnCloseVisibility\">Close</button>\n    </div>\n  </div>\n\n  <!-- Login Modal -->\n  <div id=\"loginModal\" class=\"login-modal-overlay hidden\">\n    <div class=\"login-modal\">\n      <h2>Login</h2>\n      <p>Enter your email address to receive a magic link for authentication.</p>\n\n      <div id=\"loginEmailSection\">\n        <div class=\"form-group\">\n          <label for=\"loginEmail\">Email Address</label>\n          <input type=\"email\" id=\"loginEmail\" placeholder=\"your@email.com\" autocomplete=\"email\">\n        </div>\n        <div class=\"btn-group\">\n          <button type=\"button\" id=\"btnSendMagicLink\" class=\"btn-primary\">Send Magic Link</button>\n          <button type=\"button\" id=\"btnCancelLogin\" class=\"btn-secondary\">Cancel</button>\n        </div>\n      </div>\n\n      <div id=\"loginCheckSection\" class=\"hidden\">\n        <p style=\"margin-bottom: 16px;\">A magic link has been sent to <strong id=\"sentToEmail\"></strong>. Check your email and click the link to complete login.</p>\n        <div class=\"btn-group\">\n          <button type=\"button\" id=\"btnResendLink\" class=\"btn-secondary\">Resend Link</button>\n          <button type=\"button\" id=\"btnBackToEmail\" class=\"btn-secondary\">Use Different Email</button>\n        </div>\n      </div>\n\n      <div id=\"loginStatus\" class=\"login-status hidden\"></div>\n    </div>\n  </div>\n\n  <script>\n    // Graph ID - injected by GNewAppViewerNode.vue at render time, or fallback to URL param/default\n    // The placeholder {{GRAPH_ID}} is replaced when the HTML is rendered in the knowledge graph viewer\n    function getGraphId() {\n      // First check if placeholder was replaced with actual graph ID\n      const injectedId = '{{GRAPH_ID}}';\n      if (injectedId && !injectedId.includes('{{')) {\n        return injectedId;\n      }\n      // Fallback: check URL parameter\n      const urlParams = new URLSearchParams(window.location.search);\n      const urlGraphId = urlParams.get('graph');\n      if (urlGraphId) {\n        return urlGraphId;\n      }\n      // Final fallback: default graph ID\n      return '{{GRAPH_ID_DEFAULT}}';\n    }\n\n    const GRAPH_ID = getGraphId();\n\n    // Show nodes whose label contains this substring (case-insensitive)\n    const LABEL_CONTAINS = '#';\n\n    let nodes = [];\n    let currentIndex = 0;\n    let headerImageNode = null;\n    let debugOn = false;\n\n    // View state: 'ui' or 'json'\n    let viewMode = 'ui';\n\n    // Edit mode state\n    let editMode = false;\n    let originalJsonData = null; // Store original JSON for cancel functionality\n    let currentJsonData = null;  // Current working copy of JSON\n\n    // User authentication state\n    let currentUser = null;\n    let authToken = null;\n\n    // Visibility settings state\n    let visibilitySettings = {}; // Store element visibility states\n    let visibilityPanelOpen = false;\n    let nodesLayoutMode = 'horizontal'; // NEW: 'horizontal' or 'sidebar'\n    let sidebarOpen = false; // NEW: Track sidebar open/close state\n    const VISIBILITY_CONFIG_NODE_ID = '__CONNECT_VISIBILITY_SETTINGS__';\n\n    // Check if user is Superadmin\n    function isSuperadmin() {\n      if (!currentUser) return false;\n      // Check various possible role structures\n      const role = currentUser.role || currentUser.userRole || currentUser.roles;\n      if (typeof role === 'string') {\n        return role.toLowerCase() === 'superadmin';\n      }\n      if (Array.isArray(role)) {\n        return role.some(r => (typeof r === 'string' ? r : r.name || '').toLowerCase() === 'superadmin');\n      }\n      return false;\n    }\n\n    // Try to get user from various storage locations\n    function loadUserFromStorage() {\n      try {\n        // Try localStorage first (common pattern)\n        const userStoreKeys = ['userStore', 'user', 'currentUser', 'auth', 'authUser'];\n        for (const key of userStoreKeys) {\n          const stored = localStorage.getItem(key);\n          if (stored) {\n            try {\n              const parsed = JSON.parse(stored);\n              // Handle different store structures\n              const user = parsed.user || parsed.currentUser || parsed;\n              if (user && (user.role || user.userRole || user.roles || user.email)) {\n                currentUser = user;\n                authToken = parsed.token || parsed.accessToken || parsed.authToken || localStorage.getItem('token') || localStorage.getItem('authToken');\n                console.log('Loaded user from localStorage:', key, { role: user.role || user.userRole || user.roles });\n                return true;\n              }\n            } catch (e) {\n              // Not valid JSON, continue\n            }\n          }\n        }\n\n        // Try sessionStorage\n        for (const key of userStoreKeys) {\n          const stored = sessionStorage.getItem(key);\n          if (stored) {\n            try {\n              const parsed = JSON.parse(stored);\n              const user = parsed.user || parsed.currentUser || parsed;\n              if (user && (user.role || user.userRole || user.roles || user.email)) {\n                currentUser = user;\n                authToken = parsed.token || parsed.accessToken || parsed.authToken || sessionStorage.getItem('token');\n                console.log('Loaded user from sessionStorage:', key);\n                return true;\n              }\n            } catch (e) {\n              // Not valid JSON, continue\n            }\n          }\n        }\n\n        // Check for global window variables (Vegvisr platform injection)\n        if (window.__VEGVISR_USER) {\n          currentUser = window.__VEGVISR_USER;\n          authToken = window.__VEGVISR_TOKEN || window.__VEGVISR_STORAGE_TOKEN;\n          console.log('Loaded user from window.__VEGVISR_USER');\n          return true;\n        }\n\n        // Check cookies for token\n        const cookieToken = document.cookie.split(';').find(c => c.trim().startsWith('token=') || c.trim().startsWith('authToken='));\n        if (cookieToken) {\n          authToken = cookieToken.split('=')[1];\n        }\n\n      } catch (e) {\n        console.error('Error loading user from storage:', e);\n      }\n      return false;\n    }\n\n    // Update UI based on user role\n    function updateEditButtonVisibility() {\n      const editBtn = document.getElementById('btnEditMode');\n      if (isSuperadmin()) {\n        editBtn.classList.remove('hidden');\n        editBtn.title = 'Edit Mode (Superadmin)';\n      } else {\n        editBtn.classList.add('hidden');\n      }\n    }\n\n    // Update visibility toggle buttons based on login status\n    function updateVisibilityToggleButtons() {\n      const toggles = document.querySelectorAll('.visibility-toggle');\n      if (isSuperadmin()) {\n        toggles.forEach(btn => btn.classList.add('visible'));\n      } else {\n        toggles.forEach(btn => btn.classList.remove('visible'));\n      }\n    }\n\n    // Update visibility of Superadmin-only buttons based on login status\n    function updateSuperadminButtonsVisibility() {\n      const showJsonBtn = document.getElementById('btnToggleView');\n      const debugBtn = document.getElementById('btnToggleDebug');\n      const editHeaderBtn = document.getElementById('btnEditHeaderImage');\n\n      if (isSuperadmin()) {\n        if (showJsonBtn) showJsonBtn.classList.remove('hidden');\n        if (debugBtn) debugBtn.classList.remove('hidden');\n        if (editHeaderBtn) editHeaderBtn.classList.remove('hidden');\n      } else {\n        if (showJsonBtn) showJsonBtn.classList.add('hidden');\n        if (debugBtn) debugBtn.classList.add('hidden');\n        if (editHeaderBtn) editHeaderBtn.classList.add('hidden');\n      }\n    }\n\n    // ========== VISIBILITY MANAGEMENT FUNCTIONS ==========\n\n    /**\n     * Initialize visibility controls for Superadmins\n     */\n    function initializeVisibilityControls() {\n      if (!isSuperadmin()) return;\n\n      // Find all controllable elements\n      const controllableElements = document.querySelectorAll('.controllable-element');\n\n      controllableElements.forEach(el => {\n        const elementId = el.getAttribute('data-element-id');\n        if (elementId) {\n          // Initialize visibility setting (default to visible)\n          if (!(elementId in visibilitySettings)) {\n            visibilitySettings[elementId] = true;\n          }\n\n          // Add click handler to visibility toggle button\n          const toggleBtn = el.querySelector('.visibility-toggle');\n          if (toggleBtn) {\n            toggleBtn.addEventListener('click', (e) => {\n              e.stopPropagation();\n              openVisibilityPanel(elementId);\n            });\n          }\n        }\n      });\n\n      // Attach visibility panel handlers\n      document.getElementById('btnSaveVisibility').onclick = saveVisibilitySettings;\n      document.getElementById('btnCloseVisibility').onclick = closeVisibilityPanel;\n    }\n\n    /**\n     * Open the visibility panel and populate it with current settings\n     */\n    function openVisibilityPanel(focusElementId) {\n      visibilityPanelOpen = true;\n      const panel = document.getElementById('visibilityPanel');\n      const itemsContainer = document.getElementById('visibilityItems');\n\n      // Clear existing items\n      itemsContainer.innerHTML = '';\n\n      // === NEW: Add layout mode selector ===\n      const layoutSelectorHTML = \\`\n        <div style=\"padding: 12px; background: rgba(139,92,246,0.1); border-radius: 8px; margin-bottom: 16px;\">\n          <div style=\"font-weight: 600; margin-bottom: 8px; font-size: 0.9rem;\">Nodes Navigation Layout</div>\n          <select id=\"layoutModeSelect\" style=\"width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff; font-size: 0.9rem;\">\n            <option value=\"horizontal\" \\${nodesLayoutMode === 'horizontal' ? 'selected' : ''}>Horizontal (Top Menu)</option>\n            <option value=\"sidebar\" \\${nodesLayoutMode === 'sidebar' ? 'selected' : ''}>Sidebar (Hamburger Menu)</option>\n          </select>\n        </div>\n      \\`;\n      itemsContainer.insertAdjacentHTML('beforeend', layoutSelectorHTML);\n\n      // Add change handler for layout selector\n      document.getElementById('layoutModeSelect').addEventListener('change', (e) => {\n        nodesLayoutMode = e.target.value;\n        applyNodesLayout();\n      });\n      // === END NEW ===\n\n      // Get all controllable elements\n      const controllableElements = document.querySelectorAll('.controllable-element');\n\n      controllableElements.forEach(el => {\n        const elementId = el.getAttribute('data-element-id');\n        if (elementId) {\n          const isVisible = visibilitySettings[elementId] !== false;\n          const label = getElementLabel(elementId);\n\n          const itemHTML = \\`\n            <div class=\"visibility-item\" data-element-id=\"\\${elementId}\">\n              <div class=\"visibility-item-label\">\\${label}</div>\n              <div class=\"visibility-toggle-switch \\${isVisible ? 'on' : ''}\" data-element-id=\"\\${elementId}\"></div>\n            </div>\n          \\`;\n\n          itemsContainer.insertAdjacentHTML('beforeend', itemHTML);\n        }\n      });\n\n      // Add click handlers to toggle switches\n      itemsContainer.querySelectorAll('.visibility-toggle-switch').forEach(toggle => {\n        toggle.addEventListener('click', (e) => {\n          e.stopPropagation();\n          const elementId = e.currentTarget.getAttribute('data-element-id');\n          visibilitySettings[elementId] = !toggle.classList.contains('on');\n          toggle.classList.toggle('on');\n          applyVisibilitySettings();\n        });\n      });\n\n      // Show panel\n      panel.classList.add('active');\n    }\n\n    /**\n     * Close the visibility panel\n     */\n    function closeVisibilityPanel() {\n      visibilityPanelOpen = false;\n      document.getElementById('visibilityPanel').classList.remove('active');\n    }\n\n    /**\n     * Get a human-readable label for an element ID\n     */\n    function getElementLabel(elementId) {\n      const labels = {\n        'header': 'Header with Image',\n        'stats': 'Statistics Cards',\n        'nodesList': 'Nodes Pills',\n        'mainContent': 'Main Node Content',\n        'navigation': 'Navigation Bar'\n      };\n      return labels[elementId] || elementId.charAt(0).toUpperCase() + elementId.slice(1);\n    }\n\n    /**\n     * Apply visibility settings to DOM elements\n     */\n    function applyVisibilitySettings() {\n      Object.entries(visibilitySettings).forEach(([elementId, isVisible]) => {\n        const element = document.querySelector(\\`.controllable-element[data-element-id=\"\\${elementId}\"]\\`);\n        if (element) {\n          if (isVisible) {\n            element.classList.remove('hidden-element');\n            element.style.display = '';\n          } else {\n            element.classList.add('hidden-element');\n            element.style.display = 'none';\n          }\n        }\n      });\n    }\n\n    /**\n     * Apply the selected nodes navigation layout mode\n     */\n    function applyNodesLayout() {\n      const body = document.body;\n\n      if (nodesLayoutMode === 'sidebar') {\n        // Sidebar mode\n        body.classList.add('nodes-layout-sidebar');\n        body.classList.remove('nodes-layout-horizontal');\n\n        // Rebuild pills in sidebar\n        buildSidebarPills();\n      } else {\n        // Horizontal mode (default)\n        body.classList.add('nodes-layout-horizontal');\n        body.classList.remove('nodes-layout-sidebar');\n\n        // Close sidebar if open\n        if (sidebarOpen) {\n          toggleSidebar(false);\n        }\n\n        // Rebuild pills in main area\n        buildPills();\n      }\n    }\n\n    /**\n     * Build pills for sidebar navigation\n     */\n    function buildSidebarPills() {\n      const wrap = document.getElementById('sidebarPills');\n      wrap.innerHTML = '';\n\n      if (!nodes.length) {\n        wrap.innerHTML = \\`<div class=\"soft text-sm\">No nodes found.</div>\\`;\n        return;\n      }\n\n      nodes.forEach((n, idx) => {\n        const pill = document.createElement('div');\n        pill.className = 'pill' + (idx === currentIndex ? ' pillActive' : '');\n        pill.textContent = n.label || n.id || ('Node ' + (idx + 1));\n        pill.title = \\`\\${n.label || ''}\\\\n(id: \\${n.id || '\u2014'})\\`;\n        pill.onclick = () => {\n          if (editMode) {\n            if (!confirm('Discard changes and switch node?')) return;\n            toggleEditMode(false);\n          }\n          currentIndex = idx;\n          renderCurrent();\n\n          // Close sidebar after selection only on touch devices\n          if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) {\n            toggleSidebar(false);\n          }\n        };\n        wrap.appendChild(pill);\n      });\n    }\n\n    /**\n     * Toggle sidebar open/close\n     */\n    function toggleSidebar(forceState) {\n      sidebarOpen = forceState !== undefined ? forceState : !sidebarOpen;\n\n      const sidebar = document.getElementById('sidebarNav');\n      const hamburger = document.getElementById('hamburgerButton');\n      const body = document.body;\n\n      if (sidebarOpen) {\n        sidebar.classList.add('open');\n        hamburger.classList.add('active');\n        body.classList.add('sidebar-open');\n      } else {\n        sidebar.classList.remove('open');\n        hamburger.classList.remove('active');\n        body.classList.remove('sidebar-open');\n      }\n    }\n\n    /**\n     * Update sidebar pills active state\n     */\n    function updateSidebarPillsActive() {\n      document.querySelectorAll('#sidebarPills .pill').forEach((el, idx) => {\n        el.classList.toggle('pillActive', idx === currentIndex);\n      });\n    }\n\n    /**\n     * Load visibility settings from the graph's settings node\n     */\n    async function loadVisibilitySettings() {\n      try {\n        const graphRes = await fetch('https://knowledge.vegvisr.org/getknowgraph?id=' + encodeURIComponent(GRAPH_ID));\n        if (!graphRes.ok) return;\n\n        const graphData = await graphRes.json();\n        const allNodes = Array.isArray(graphData.nodes) ? graphData.nodes : [];\n\n        // Find the visibility settings node\n        const settingsNode = allNodes.find(node => node.id === VISIBILITY_CONFIG_NODE_ID);\n\n        if (settingsNode && settingsNode.info) {\n          try {\n            const jsonData = extractJsonFromInfo(String(settingsNode.info || ''));\n            if (jsonData && jsonData.visibility) {\n              visibilitySettings = jsonData.visibility;\n              console.log('Loaded visibility settings from graph:', visibilitySettings);\n              applyVisibilitySettings();\n            }\n\n            // === NEW: Load layout mode ===\n            if (jsonData && jsonData.nodesLayout) {\n              nodesLayoutMode = jsonData.nodesLayout;\n              console.log('Loaded nodes layout mode:', nodesLayoutMode);\n              applyNodesLayout();\n            }\n            // === END NEW ===\n\n          } catch (e) {\n            console.log('Could not parse visibility settings:', e);\n          }\n        }\n      } catch (err) {\n        console.log('Could not load visibility settings:', err.message);\n      }\n    }\n\n    /**\n     * Save visibility settings to the graph's settings node\n     */\n    async function saveVisibilitySettings() {\n      if (!isSuperadmin()) {\n        alert('Only Superadmins can save visibility settings.');\n        return;\n      }\n\n      const saveBtn = document.getElementById('btnSaveVisibility');\n      const originalText = saveBtn.textContent;\n      saveBtn.disabled = true;\n      saveBtn.textContent = 'Saving...';\n\n      try {\n        // Fetch current graph\n        const graphRes = await fetch('https://knowledge.vegvisr.org/getknowgraph?id=' + encodeURIComponent(GRAPH_ID));\n        if (!graphRes.ok) {\n          throw new Error('Failed to fetch graph');\n        }\n\n        const graphData = await graphRes.json();\n        const allNodes = Array.isArray(graphData.nodes) ? graphData.nodes : [];\n\n        // Find or create the settings node\n        let settingsNode = allNodes.find(node => node.id === VISIBILITY_CONFIG_NODE_ID);\n\n        const settingsData = {\n          title: 'Visibility Settings',\n          description: 'Auto-generated settings node for page element visibility (managed by Superadmin)',\n          visibility: visibilitySettings,\n          nodesLayout: nodesLayoutMode, // === NEW ===\n          updatedAt: new Date().toISOString(),\n          updatedBy: currentUser.email || currentUser.username || currentUser.id\n        };\n\n        if (settingsNode) {\n          // Update existing node\n          settingsNode.label = 'Visibility Settings';\n          settingsNode.info = JSON.stringify(settingsData, null, 2);\n          console.log('Updated visibility settings node');\n        } else {\n          // Create new node\n          settingsNode = {\n            id: VISIBILITY_CONFIG_NODE_ID,\n            label: 'Visibility Settings',\n            type: 'visibility-settings',\n            info: JSON.stringify(settingsData, null, 2),\n            path: '',\n            bibl: []\n          };\n          allNodes.push(settingsNode);\n          console.log('Created new visibility settings node');\n        }\n\n        // Save updated graph\n        const updateRes = await fetch('https://knowledge.vegvisr.org/updateknowgraph', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({\n            id: GRAPH_ID,\n            graphData: {\n              nodes: allNodes,\n              edges: graphData.edges || []\n            }\n          })\n        });\n\n        if (!updateRes.ok) {\n          const errorData = await updateRes.json().catch(() => ({}));\n          throw new Error(errorData.error || errorData.message || 'Failed to update graph');\n        }\n\n        saveBtn.textContent = 'Saved!';\n        saveBtn.style.background = 'rgba(74, 222, 128, 0.3)';\n\n        setTimeout(() => {\n          saveBtn.disabled = false;\n          saveBtn.textContent = originalText;\n          saveBtn.style.background = '';\n          closeVisibilityPanel();\n        }, 1500);\n\n        console.log('Visibility settings saved successfully');\n\n      } catch (err) {\n        console.error('Error saving visibility settings:', err);\n        saveBtn.textContent = 'Error!';\n        saveBtn.style.background = 'rgba(248, 113, 113, 0.3)';\n        alert('Error saving settings: ' + err.message);\n\n        setTimeout(() => {\n          saveBtn.disabled = false;\n          saveBtn.textContent = originalText;\n          saveBtn.style.background = '';\n        }, 1500);\n      }\n    }\n\n    // ========== EXTRACT JSON FROM INFO FIELD ==========\n    // The info field may contain JSON wrapped in markdown code fences\n    function extractJsonFromInfo(info) {\n      if (!info || typeof info !== 'string') return null;\n\n      const trimmed = info.trim();\n\n      // Try to parse directly first (it might be pure JSON)\n      try {\n        const parsed = JSON.parse(trimmed);\n        if (typeof parsed === 'object' && parsed !== null) {\n          return parsed;\n        }\n      } catch (e) {\n        // Not direct JSON, continue\n      }\n\n      // Look for JSON in markdown code fences: \\`\\`\\`json ... \\`\\`\\` or \\`\\`\\` ... \\`\\`\\`\n      const codeFenceRegex = /\\`\\`\\`(?:json)?\\\\s*([\\\\s\\\\S]*?)\\`\\`\\`/gi;\n      let match;\n      while ((match = codeFenceRegex.exec(trimmed)) !== null) {\n        try {\n          const parsed = JSON.parse(match[1].trim());\n          if (typeof parsed === 'object' && parsed !== null) {\n            return parsed;\n          }\n        } catch (e) {\n          // Not valid JSON in this fence, continue\n        }\n      }\n\n      // Look for JSON object or array pattern\n      const jsonPatterns = [\n        /(\\\\{[\\\\s\\\\S]*\\\\})/,  // Object\n        /(\\\\[[\\\\s\\\\S]*\\\\])/   // Array\n      ];\n\n      for (const pattern of jsonPatterns) {\n        const jsonMatch = trimmed.match(pattern);\n        if (jsonMatch) {\n          try {\n            const parsed = JSON.parse(jsonMatch[1]);\n            if (typeof parsed === 'object' && parsed !== null) {\n              return parsed;\n            }\n          } catch (e) {\n            // Not valid JSON\n          }\n        }\n      }\n\n      return null;\n    }\n\n    // ========== RENDER JSON SCHEMA AS UI ==========\n    function renderJsonAsUI(data) {\n      if (!data || typeof data !== 'object') {\n        return null;\n      }\n\n      let html = '<div class=\"ui-form\">';\n\n      // Render title if present\n      if (data.title) {\n        html += \\`<div class=\"ui-form-title\">\\${escapeHtml(data.title)}</div>\\`;\n      }\n\n      // Render description if present\n      if (data.description) {\n        html += \\`<div class=\"ui-form-description\">\\${escapeHtml(data.description)}</div>\\`;\n      }\n\n      // Render blocks if present (form schema pattern)\n      if (Array.isArray(data.blocks)) {\n        for (const block of data.blocks) {\n          html += renderBlock(block);\n        }\n      }\n\n      // Render fields directly if present\n      if (Array.isArray(data.fields)) {\n        html += '<div class=\"ui-block\">';\n        for (const field of data.fields) {\n          html += renderField(field);\n        }\n        html += '</div>';\n      }\n\n      // Render options/choices if present at top level\n      if (Array.isArray(data.options)) {\n        html += renderChoices(data.options, data.field || 'choice');\n      }\n\n      // Render steps if present\n      if (Array.isArray(data.steps)) {\n        for (let i = 0; i < data.steps.length; i++) {\n          const step = data.steps[i];\n          html += \\`<div class=\"ui-block\">\\`;\n          html += \\`<div class=\"ui-block-title\">Step \\${i + 1}\\${step.title ? ': ' + escapeHtml(step.title) : ''}</div>\\`;\n          if (step.description) {\n            html += \\`<p style=\"color: rgba(255,255,255,0.7); margin-bottom: 12px;\">\\${escapeHtml(step.description)}</p>\\`;\n          }\n          if (Array.isArray(step.fields)) {\n            for (const field of step.fields) {\n              html += renderField(field);\n            }\n          }\n          if (Array.isArray(step.options)) {\n            html += renderChoices(step.options, step.field || \\`step_\\${i}_choice\\`);\n          }\n          html += '</div>';\n        }\n      }\n\n      // Render items if present (generic list)\n      if (Array.isArray(data.items)) {\n        html += '<div class=\"ui-block\">';\n        for (const item of data.items) {\n          if (typeof item === 'string') {\n            html += \\`<div class=\"ui-field\">\\${escapeHtml(item)}</div>\\`;\n          } else if (typeof item === 'object') {\n            html += renderField(item);\n          }\n        }\n        html += '</div>';\n      }\n\n      // Render content if present\n      if (data.content) {\n        if (typeof data.content === 'string') {\n          html += \\`<div class=\"ui-block\">\\${marked.parse(data.content)}</div>\\`;\n        }\n      }\n\n      // Render action/button if present\n      if (data.action || data.button) {\n        const btnText = data.action || data.button;\n        html += \\`<div><button class=\"ui-button\">\\${escapeHtml(typeof btnText === 'string' ? btnText : 'Submit')}</button></div>\\`;\n      }\n\n      html += '</div>';\n      return html;\n    }\n\n    function renderBlock(block) {\n      if (!block || typeof block !== 'object') return '';\n\n      let html = '<div class=\"ui-block\">';\n\n      // Block title\n      if (block.title || block.label) {\n        html += \\`<div class=\"ui-block-title\">\\${escapeHtml(block.title || block.label)}</div>\\`;\n      }\n\n      // Block description\n      if (block.description) {\n        html += \\`<p style=\"color: rgba(255,255,255,0.7); margin-bottom: 12px;\">\\${escapeHtml(block.description)}</p>\\`;\n      }\n\n      // Handle different block types\n      const blockType = (block.type || '').toLowerCase();\n\n      switch (blockType) {\n        case 'inputs':\n        case 'form':\n        case 'fields':\n          if (Array.isArray(block.fields)) {\n            for (const field of block.fields) {\n              html += renderField(field);\n            }\n          }\n          break;\n\n        case 'choice':\n        case 'choices':\n        case 'select':\n        case 'options':\n          if (Array.isArray(block.options)) {\n            html += renderChoices(block.options, block.field || block.name || 'choice');\n          }\n          break;\n\n        case 'info':\n        case 'information':\n          html += \\`<div class=\"ui-info-box\">\\${block.text ? escapeHtml(block.text) : (block.content ? marked.parse(block.content) : '')}</div>\\`;\n          break;\n\n        case 'warning':\n          html += \\`<div class=\"ui-warning-box\">\\${block.text ? escapeHtml(block.text) : (block.content ? marked.parse(block.content) : '')}</div>\\`;\n          break;\n\n        case 'text':\n        case 'markdown':\n        case 'content':\n          if (block.text || block.content) {\n            html += marked.parse(block.text || block.content);\n          }\n          break;\n\n        default:\n          // Try to render fields if present\n          if (Array.isArray(block.fields)) {\n            for (const field of block.fields) {\n              html += renderField(field);\n            }\n          }\n          // Try to render options if present\n          if (Array.isArray(block.options)) {\n            html += renderChoices(block.options, block.field || block.name || 'choice');\n          }\n          // Render text/content if present\n          if (block.text) {\n            html += \\`<p>\\${escapeHtml(block.text)}</p>\\`;\n          }\n          break;\n      }\n\n      html += '</div>';\n      return html;\n    }\n\n    function renderField(field) {\n      if (!field || typeof field !== 'object') return '';\n\n      const fieldType = (field.type || 'text').toLowerCase();\n      const fieldName = field.name || field.field || field.id || 'field_' + Math.random().toString(36).substr(2, 9);\n      const fieldLabel = field.label || field.title || fieldName;\n      const placeholder = field.placeholder || '';\n      const required = field.required ? 'required' : '';\n\n      let html = '<div class=\"ui-field\">';\n\n      // Label\n      if (fieldLabel) {\n        html += \\`<label class=\"ui-label\" for=\"\\${escapeHtml(fieldName)}\">\\${escapeHtml(fieldLabel)}\\${field.required ? ' *' : ''}</label>\\`;\n      }\n\n      switch (fieldType) {\n        case 'text':\n        case 'string':\n        case 'email':\n        case 'tel':\n        case 'phone':\n        case 'url':\n        case 'number':\n          const inputType = fieldType === 'string' ? 'text' : (fieldType === 'phone' ? 'tel' : fieldType);\n          html += \\`<input type=\"\\${inputType}\" class=\"ui-input\" id=\"\\${escapeHtml(fieldName)}\" name=\"\\${escapeHtml(fieldName)}\" placeholder=\"\\${escapeHtml(placeholder)}\" \\${required}>\\`;\n          break;\n\n        case 'textarea':\n        case 'longtext':\n        case 'multiline':\n          html += \\`<textarea class=\"ui-textarea\" id=\"\\${escapeHtml(fieldName)}\" name=\"\\${escapeHtml(fieldName)}\" placeholder=\"\\${escapeHtml(placeholder)}\" \\${required}></textarea>\\`;\n          break;\n\n        case 'select':\n        case 'dropdown':\n          html += \\`<select class=\"ui-select\" id=\"\\${escapeHtml(fieldName)}\" name=\"\\${escapeHtml(fieldName)}\" \\${required}>\\`;\n          html += \\`<option value=\"\">Select...</option>\\`;\n          if (Array.isArray(field.options)) {\n            for (const opt of field.options) {\n              if (typeof opt === 'string') {\n                html += \\`<option value=\"\\${escapeHtml(opt)}\">\\${escapeHtml(opt)}</option>\\`;\n              } else if (typeof opt === 'object') {\n                const val = opt.value || opt.id || opt.label || '';\n                const label = opt.label || opt.title || opt.value || '';\n                html += \\`<option value=\"\\${escapeHtml(val)}\">\\${escapeHtml(label)}</option>\\`;\n              }\n            }\n          }\n          html += '</select>';\n          break;\n\n        case 'checkbox':\n          if (Array.isArray(field.options)) {\n            html += '<div class=\"ui-checkbox-group\">';\n            for (const opt of field.options) {\n              const optValue = typeof opt === 'string' ? opt : (opt.value || opt.id || opt.label || '');\n              const optLabel = typeof opt === 'string' ? opt : (opt.label || opt.title || opt.value || '');\n              html += \\`<label class=\"ui-checkbox-item\"><input type=\"checkbox\" name=\"\\${escapeHtml(fieldName)}\" value=\"\\${escapeHtml(optValue)}\"> \\${escapeHtml(optLabel)}</label>\\`;\n            }\n            html += '</div>';\n          } else {\n            html += \\`<label class=\"ui-checkbox-item\"><input type=\"checkbox\" id=\"\\${escapeHtml(fieldName)}\" name=\"\\${escapeHtml(fieldName)}\"> \\${escapeHtml(field.checkboxLabel || fieldLabel)}</label>\\`;\n          }\n          break;\n\n        case 'radio':\n          html += '<div class=\"ui-radio-group\">';\n          if (Array.isArray(field.options)) {\n            for (const opt of field.options) {\n              const optValue = typeof opt === 'string' ? opt : (opt.value || opt.id || opt.label || '');\n              const optLabel = typeof opt === 'string' ? opt : (opt.label || opt.title || opt.value || '');\n              html += \\`<label class=\"ui-radio-item\"><input type=\"radio\" name=\"\\${escapeHtml(fieldName)}\" value=\"\\${escapeHtml(optValue)}\"> \\${escapeHtml(optLabel)}</label>\\`;\n            }\n          }\n          html += '</div>';\n          break;\n\n        case 'date':\n        case 'time':\n        case 'datetime':\n          const dateInputType = fieldType === 'datetime' ? 'datetime-local' : fieldType;\n          html += \\`<input type=\"\\${dateInputType}\" class=\"ui-input\" id=\"\\${escapeHtml(fieldName)}\" name=\"\\${escapeHtml(fieldName)}\" \\${required}>\\`;\n          break;\n\n        default:\n          html += \\`<input type=\"text\" class=\"ui-input\" id=\"\\${escapeHtml(fieldName)}\" name=\"\\${escapeHtml(fieldName)}\" placeholder=\"\\${escapeHtml(placeholder)}\" \\${required}>\\`;\n          break;\n      }\n\n      // Help text\n      if (field.help || field.description) {\n        html += \\`<div style=\"font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-top: 4px;\">\\${escapeHtml(field.help || field.description)}</div>\\`;\n      }\n\n      html += '</div>';\n      return html;\n    }\n\n    function renderChoices(options, fieldName) {\n      if (!Array.isArray(options) || options.length === 0) return '';\n\n      let html = '<div class=\"ui-choice-grid\">';\n      for (const opt of options) {\n        if (typeof opt === 'string') {\n          html += \\`<div class=\"ui-choice-card\" data-field=\"\\${escapeHtml(fieldName)}\" data-value=\"\\${escapeHtml(opt)}\">\n            <div class=\"ui-choice-card-title\">\\${escapeHtml(opt)}</div>\n          </div>\\`;\n        } else if (typeof opt === 'object') {\n          const value = opt.value || opt.id || opt.label || '';\n          const title = opt.label || opt.title || opt.name || value;\n          const desc = opt.description || opt.desc || '';\n          html += \\`<div class=\"ui-choice-card\" data-field=\"\\${escapeHtml(fieldName)}\" data-value=\"\\${escapeHtml(value)}\">\n            <div class=\"ui-choice-card-title\">\\${escapeHtml(title)}</div>\n            \\${desc ? \\`<div class=\"ui-choice-card-desc\">\\${escapeHtml(desc)}</div>\\` : ''}\n          </div>\\`;\n        }\n      }\n      html += '</div>';\n      return html;\n    }\n\n    function escapeHtml(str) {\n      if (typeof str !== 'string') return '';\n      return str\n        .replace(/&/g, '&amp;')\n        .replace(/</g, '&lt;')\n        .replace(/>/g, '&gt;')\n        .replace(/\"/g, '&quot;')\n        .replace(/'/g, '&#039;');\n    }\n\n    // Add click handlers for choice cards\n    function attachChoiceCardHandlers() {\n      document.querySelectorAll('.ui-choice-card').forEach(card => {\n        card.addEventListener('click', function() {\n          const field = this.dataset.field;\n          // Deselect siblings\n          document.querySelectorAll(\\`.ui-choice-card[data-field=\"\\${field}\"]\\`).forEach(c => c.classList.remove('selected'));\n          // Select this one\n          this.classList.add('selected');\n        });\n      });\n    }\n\n    // ========== EDIT MODE FUNCTIONS ==========\n\n    function setEditStatus(message, type = '') {\n      const statusEl = document.getElementById('editStatus');\n      statusEl.textContent = message;\n      statusEl.className = 'status' + (type ? ' ' + type : '');\n    }\n\n    function toggleEditMode(enable) {\n      editMode = enable;\n      const toolbar = document.getElementById('editToolbar');\n      const preview = document.getElementById('nodePreview');\n      const editBtn = document.getElementById('btnEditMode');\n      const n = nodes[currentIndex];\n\n      if (enable) {\n        // Check if this is a YouTube node\n        if (isYouTubeNode(n)) {\n          // Store original node data for cancel\n          originalJsonData = {\n            path: n.path || '',\n            info: n.info || '',\n            bibl: n.bibl ? [...n.bibl] : []\n          };\n          currentJsonData = null; // Not using JSON data for YouTube nodes\n        } else if (isFulltextNode(n)) {\n          // Store original fulltext for cancel\n          originalJsonData = {\n            info: n.info || ''\n          };\n          currentJsonData = null; // Not using JSON data for fulltext nodes\n        } else {\n          // Store original JSON for cancel\n          const info = normalizeStr(n.info);\n          originalJsonData = extractJsonFromInfo(info);\n          currentJsonData = JSON.parse(JSON.stringify(originalJsonData)); // Deep clone\n        }\n\n        toolbar.classList.remove('hidden');\n        preview.classList.add('edit-mode');\n        editBtn.textContent = 'Editing...';\n        editBtn.disabled = true;\n\n        // Re-render with edit capabilities\n        renderCurrentEditMode();\n\n        if (isYouTubeNode(n)) {\n          setEditStatus('Edit mode: Modify the YouTube URL and description, then save.');\n        } else if (isFulltextNode(n)) {\n          setEditStatus('Edit mode: Edit the content below (Markdown supported), then save.');\n        } else {\n          setEditStatus('Edit mode: Click labels to rename, modify values, then save.');\n        }\n      } else {\n        toolbar.classList.add('hidden');\n        preview.classList.remove('edit-mode');\n        editBtn.textContent = 'Edit Mode';\n        editBtn.disabled = false;\n        originalJsonData = null;\n        currentJsonData = null;\n\n        // Re-render normal view\n        renderCurrent();\n      }\n    }\n\n    function renderCurrentEditMode() {\n      const n = nodes[currentIndex];\n\n      // Check if this is a YouTube node\n      if (isYouTubeNode(n)) {\n        const rendered = renderYouTubeNodeEditable(n);\n        setHTML('nodePreview', rendered);\n        attachYouTubeEditHandlers();\n        return;\n      }\n\n      // Check if this is a fulltext node\n      if (isFulltextNode(n)) {\n        const rendered = renderFulltextNodeEditable(n);\n        setHTML('nodePreview', rendered);\n        attachFulltextEditHandlers();\n        return;\n      }\n\n      // Regular JSON node editing\n      if (!currentJsonData) {\n        setEditStatus('No JSON data to edit in this node.', 'error');\n        return;\n      }\n\n      const rendered = renderJsonAsUIEditable(currentJsonData);\n      setHTML('nodePreview', rendered);\n      attachEditableHandlers();\n      attachChoiceCardHandlers();\n    }\n\n    // Render JSON as editable UI\n    function renderJsonAsUIEditable(data) {\n      if (!data || typeof data !== 'object') {\n        return '<div class=\"soft text-sm\">No editable JSON structure found.</div>';\n      }\n\n      let html = '<div class=\"ui-form edit-mode\">';\n\n      // Editable title\n      if (data.title !== undefined) {\n        html += \\`<div class=\"ui-form-title editable\" data-path=\"title\">\\${escapeHtml(data.title || 'Untitled')}</div>\\`;\n      }\n\n      // Editable description\n      if (data.description !== undefined) {\n        html += \\`<div class=\"ui-form-description editable\" data-path=\"description\">\\${escapeHtml(data.description || 'No description')}</div>\\`;\n      }\n\n      // Render blocks\n      if (Array.isArray(data.blocks)) {\n        for (let i = 0; i < data.blocks.length; i++) {\n          html += renderBlockEditable(data.blocks[i], \\`blocks.\\${i}\\`);\n        }\n      }\n\n      // Render fields directly\n      if (Array.isArray(data.fields)) {\n        html += '<div class=\"ui-block\">';\n        for (let i = 0; i < data.fields.length; i++) {\n          html += renderFieldEditable(data.fields[i], \\`fields.\\${i}\\`);\n        }\n        html += \\`<button type=\"button\" class=\"btn-add-field\" data-path=\"fields\">+ Add Field</button>\\`;\n        html += '</div>';\n      }\n\n      // Render options/choices\n      if (Array.isArray(data.options)) {\n        html += renderChoicesEditable(data.options, data.field || 'choice', 'options');\n      }\n\n      // Render steps\n      if (Array.isArray(data.steps)) {\n        for (let i = 0; i < data.steps.length; i++) {\n          const step = data.steps[i];\n          html += \\`<div class=\"ui-block\">\\`;\n          html += \\`<div class=\"ui-block-title editable\" data-path=\"steps.\\${i}.title\">Step \\${i + 1}\\${step.title ? ': ' + escapeHtml(step.title) : ''}</div>\\`;\n          if (step.description !== undefined) {\n            html += \\`<p class=\"editable\" style=\"color: rgba(255,255,255,0.7); margin-bottom: 12px;\" data-path=\"steps.\\${i}.description\">\\${escapeHtml(step.description || 'No description')}</p>\\`;\n          }\n          if (Array.isArray(step.fields)) {\n            for (let j = 0; j < step.fields.length; j++) {\n              html += renderFieldEditable(step.fields[j], \\`steps.\\${i}.fields.\\${j}\\`);\n            }\n            html += \\`<button type=\"button\" class=\"btn-add-field\" data-path=\"steps.\\${i}.fields\">+ Add Field</button>\\`;\n          }\n          if (Array.isArray(step.options)) {\n            html += renderChoicesEditable(step.options, step.field || \\`step_\\${i}_choice\\`, \\`steps.\\${i}.options\\`);\n          }\n          html += '</div>';\n        }\n      }\n\n      // Render items\n      if (Array.isArray(data.items)) {\n        html += '<div class=\"ui-block\">';\n        for (let i = 0; i < data.items.length; i++) {\n          const item = data.items[i];\n          if (typeof item === 'string') {\n            html += \\`<div class=\"ui-field edit-mode-field\"><span class=\"editable\" data-path=\"items.\\${i}\">\\${escapeHtml(item)}</span></div>\\`;\n          } else if (typeof item === 'object') {\n            html += renderFieldEditable(item, \\`items.\\${i}\\`);\n          }\n        }\n        html += '</div>';\n      }\n\n      html += '</div>';\n      return html;\n    }\n\n    function renderBlockEditable(block, basePath) {\n      if (!block || typeof block !== 'object') return '';\n\n      let html = '<div class=\"ui-block\">';\n\n      // Editable block title\n      if (block.title !== undefined || block.label !== undefined) {\n        const titlePath = block.title !== undefined ? \\`\\${basePath}.title\\` : \\`\\${basePath}.label\\`;\n        html += \\`<div class=\"ui-block-title editable\" data-path=\"\\${titlePath}\">\\${escapeHtml(block.title || block.label || 'Untitled Block')}</div>\\`;\n      }\n\n      // Editable description\n      if (block.description !== undefined) {\n        html += \\`<p class=\"editable\" style=\"color: rgba(255,255,255,0.7); margin-bottom: 12px;\" data-path=\"\\${basePath}.description\">\\${escapeHtml(block.description || 'No description')}</p>\\`;\n      }\n\n      const blockType = (block.type || '').toLowerCase();\n\n      // Render fields\n      if (Array.isArray(block.fields)) {\n        for (let i = 0; i < block.fields.length; i++) {\n          html += renderFieldEditable(block.fields[i], \\`\\${basePath}.fields.\\${i}\\`);\n        }\n        html += \\`<button type=\"button\" class=\"btn-add-field\" data-path=\"\\${basePath}.fields\">+ Add Field</button>\\`;\n      }\n\n      // Render options\n      if (Array.isArray(block.options)) {\n        html += renderChoicesEditable(block.options, block.field || block.name || 'choice', \\`\\${basePath}.options\\`);\n      }\n\n      // Render text content\n      if (block.text !== undefined) {\n        html += \\`<p class=\"editable\" data-path=\"\\${basePath}.text\">\\${escapeHtml(block.text)}</p>\\`;\n      }\n\n      html += '</div>';\n      return html;\n    }\n\n    function renderFieldEditable(field, basePath) {\n      if (!field || typeof field !== 'object') return '';\n\n      const fieldType = (field.type || 'text').toLowerCase();\n      const fieldName = field.name || field.field || field.id || 'field_' + Math.random().toString(36).substr(2, 9);\n      const fieldLabel = field.label || field.title || fieldName;\n      const placeholder = field.placeholder || '';\n\n      let html = '<div class=\"ui-field edit-mode-field\">';\n\n      // Delete button\n      html += \\`<button type=\"button\" class=\"btn-delete-field\" data-path=\"\\${basePath}\" title=\"Delete field\">\u00D7</button>\\`;\n\n      // Editable label\n      html += \\`<label class=\"ui-label editable\" data-path=\"\\${basePath}.label\" for=\"\\${escapeHtml(fieldName)}\">\\${escapeHtml(fieldLabel)}\\${field.required ? ' *' : ''}</label>\\`;\n\n      // Input with data-path for value tracking\n      switch (fieldType) {\n        case 'text':\n        case 'string':\n        case 'email':\n        case 'tel':\n        case 'phone':\n        case 'url':\n        case 'number':\n          const inputType = fieldType === 'string' ? 'text' : (fieldType === 'phone' ? 'tel' : fieldType);\n          html += \\`<input type=\"\\${inputType}\" class=\"ui-input\" data-value-path=\"\\${basePath}.value\" id=\"\\${escapeHtml(fieldName)}\" name=\"\\${escapeHtml(fieldName)}\" placeholder=\"\\${escapeHtml(placeholder)}\" value=\"\\${escapeHtml(field.value || '')}\">\\`;\n          break;\n\n        case 'textarea':\n        case 'longtext':\n        case 'multiline':\n          html += \\`<textarea class=\"ui-textarea\" data-value-path=\"\\${basePath}.value\" id=\"\\${escapeHtml(fieldName)}\" name=\"\\${escapeHtml(fieldName)}\" placeholder=\"\\${escapeHtml(placeholder)}\">\\${escapeHtml(field.value || '')}</textarea>\\`;\n          break;\n\n        case 'select':\n        case 'dropdown':\n          html += \\`<select class=\"ui-select\" data-value-path=\"\\${basePath}.value\" id=\"\\${escapeHtml(fieldName)}\" name=\"\\${escapeHtml(fieldName)}\">\\`;\n          html += \\`<option value=\"\">Select...</option>\\`;\n          if (Array.isArray(field.options)) {\n            for (const opt of field.options) {\n              const val = typeof opt === 'string' ? opt : (opt.value || opt.id || opt.label || '');\n              const label = typeof opt === 'string' ? opt : (opt.label || opt.title || opt.value || '');\n              const selected = field.value === val ? 'selected' : '';\n              html += \\`<option value=\"\\${escapeHtml(val)}\" \\${selected}>\\${escapeHtml(label)}</option>\\`;\n            }\n          }\n          html += '</select>';\n          break;\n\n        case 'checkbox':\n          if (Array.isArray(field.options)) {\n            html += '<div class=\"ui-checkbox-group\">';\n            for (let i = 0; i < field.options.length; i++) {\n              const opt = field.options[i];\n              const optValue = typeof opt === 'string' ? opt : (opt.value || opt.id || opt.label || '');\n              const optLabel = typeof opt === 'string' ? opt : (opt.label || opt.title || opt.value || '');\n              const checked = Array.isArray(field.value) && field.value.includes(optValue) ? 'checked' : '';\n              html += \\`<label class=\"ui-checkbox-item\"><input type=\"checkbox\" data-value-path=\"\\${basePath}.value\" name=\"\\${escapeHtml(fieldName)}\" value=\"\\${escapeHtml(optValue)}\" \\${checked}> \\${escapeHtml(optLabel)}</label>\\`;\n            }\n            html += '</div>';\n          } else {\n            const checked = field.value ? 'checked' : '';\n            html += \\`<label class=\"ui-checkbox-item\"><input type=\"checkbox\" data-value-path=\"\\${basePath}.value\" id=\"\\${escapeHtml(fieldName)}\" name=\"\\${escapeHtml(fieldName)}\" \\${checked}> \\${escapeHtml(field.checkboxLabel || fieldLabel)}</label>\\`;\n          }\n          break;\n\n        case 'radio':\n          html += '<div class=\"ui-radio-group\">';\n          if (Array.isArray(field.options)) {\n            for (const opt of field.options) {\n              const optValue = typeof opt === 'string' ? opt : (opt.value || opt.id || opt.label || '');\n              const optLabel = typeof opt === 'string' ? opt : (opt.label || opt.title || opt.value || '');\n              const checked = field.value === optValue ? 'checked' : '';\n              html += \\`<label class=\"ui-radio-item\"><input type=\"radio\" data-value-path=\"\\${basePath}.value\" name=\"\\${escapeHtml(fieldName)}\" value=\"\\${escapeHtml(optValue)}\" \\${checked}> \\${escapeHtml(optLabel)}</label>\\`;\n            }\n          }\n          html += '</div>';\n          break;\n\n        default:\n          html += \\`<input type=\"text\" class=\"ui-input\" data-value-path=\"\\${basePath}.value\" id=\"\\${escapeHtml(fieldName)}\" name=\"\\${escapeHtml(fieldName)}\" placeholder=\"\\${escapeHtml(placeholder)}\" value=\"\\${escapeHtml(field.value || '')}\">\\`;\n          break;\n      }\n\n      // Help text (editable)\n      if (field.help !== undefined || field.description !== undefined) {\n        const helpPath = field.help !== undefined ? \\`\\${basePath}.help\\` : \\`\\${basePath}.description\\`;\n        html += \\`<div class=\"editable\" style=\"font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-top: 4px;\" data-path=\"\\${helpPath}\">\\${escapeHtml(field.help || field.description || 'Add help text...')}</div>\\`;\n      }\n\n      html += '</div>';\n      return html;\n    }\n\n    function renderChoicesEditable(options, fieldName, basePath) {\n      if (!Array.isArray(options) || options.length === 0) return '';\n\n      let html = '<div class=\"ui-choice-grid\">';\n      for (let i = 0; i < options.length; i++) {\n        const opt = options[i];\n        if (typeof opt === 'string') {\n          html += \\`<div class=\"ui-choice-card\" data-field=\"\\${escapeHtml(fieldName)}\" data-value=\"\\${escapeHtml(opt)}\" data-path=\"\\${basePath}.\\${i}\">\n            <div class=\"ui-choice-card-title editable\" data-path=\"\\${basePath}.\\${i}\">\\${escapeHtml(opt)}</div>\n          </div>\\`;\n        } else if (typeof opt === 'object') {\n          const value = opt.value || opt.id || opt.label || '';\n          const title = opt.label || opt.title || opt.name || value;\n          const desc = opt.description || opt.desc || '';\n          html += \\`<div class=\"ui-choice-card\" data-field=\"\\${escapeHtml(fieldName)}\" data-value=\"\\${escapeHtml(value)}\">\n            <div class=\"ui-choice-card-title editable\" data-path=\"\\${basePath}.\\${i}.label\">\\${escapeHtml(title)}</div>\n            <div class=\"ui-choice-card-desc editable\" data-path=\"\\${basePath}.\\${i}.description\">\\${escapeHtml(desc || 'Add description...')}</div>\n          </div>\\`;\n        }\n      }\n      html += '</div>';\n      return html;\n    }\n\n    // Attach handlers for editable elements\n    function attachEditableHandlers() {\n      // Editable text elements (labels, titles, descriptions)\n      document.querySelectorAll('.editable').forEach(el => {\n        el.addEventListener('click', function(e) {\n          if (!editMode) return;\n          e.stopPropagation();\n\n          const path = this.dataset.path;\n          const currentValue = getValueByPath(currentJsonData, path) || '';\n          const isTitle = this.classList.contains('ui-form-title');\n          const isMultiline = this.tagName === 'P' || path.includes('description');\n\n          // Create input\n          const input = isMultiline\n            ? document.createElement('textarea')\n            : document.createElement('input');\n\n          input.className = isTitle ? 'ui-form-title-input' : 'ui-label-input';\n          input.value = currentValue;\n          if (isMultiline) {\n            input.style.minHeight = '60px';\n            input.style.width = '100%';\n          }\n\n          // Replace element with input\n          const originalDisplay = this.style.display;\n          this.style.display = 'none';\n          this.parentNode.insertBefore(input, this);\n          input.focus();\n          input.select();\n\n          // Handle blur/enter\n          const finishEdit = () => {\n            const newValue = input.value;\n            setValueByPath(currentJsonData, path, newValue);\n            this.textContent = newValue || '(empty)';\n            this.style.display = originalDisplay || '';\n            input.remove();\n          };\n\n          input.addEventListener('blur', finishEdit);\n          input.addEventListener('keydown', (e) => {\n            if (e.key === 'Enter' && !isMultiline) {\n              e.preventDefault();\n              finishEdit();\n            }\n            if (e.key === 'Escape') {\n              this.style.display = originalDisplay || '';\n              input.remove();\n            }\n          });\n        });\n      });\n\n      // Value inputs - track changes\n      document.querySelectorAll('[data-value-path]').forEach(input => {\n        input.addEventListener('change', function() {\n          const path = this.dataset.valuePath;\n          let value;\n\n          if (this.type === 'checkbox') {\n            // Handle checkbox groups\n            const name = this.name;\n            const checkboxes = document.querySelectorAll(\\`input[name=\"\\${name}\"]:checked\\`);\n            if (checkboxes.length > 1 || this.parentNode.parentNode.classList.contains('ui-checkbox-group')) {\n              value = Array.from(checkboxes).map(cb => cb.value);\n            } else {\n              value = this.checked;\n            }\n          } else if (this.type === 'radio') {\n            value = this.value;\n          } else {\n            value = this.value;\n          }\n\n          setValueByPath(currentJsonData, path, value);\n        });\n\n        // Also track on input for text fields\n        if (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA') {\n          input.addEventListener('input', function() {\n            if (this.type !== 'checkbox' && this.type !== 'radio') {\n              setValueByPath(currentJsonData, this.dataset.valuePath, this.value);\n            }\n          });\n        }\n      });\n\n      // Delete field buttons\n      document.querySelectorAll('.btn-delete-field').forEach(btn => {\n        btn.addEventListener('click', function(e) {\n          e.stopPropagation();\n          const path = this.dataset.path;\n          if (confirm('Delete this field?')) {\n            deleteByPath(currentJsonData, path);\n            renderCurrentEditMode();\n          }\n        });\n      });\n\n      // Add field buttons\n      document.querySelectorAll('.btn-add-field').forEach(btn => {\n        btn.addEventListener('click', function(e) {\n          e.stopPropagation();\n          const path = this.dataset.path;\n          const newField = {\n            label: 'New Field',\n            type: 'text',\n            name: 'field_' + Date.now(),\n            value: ''\n          };\n          addToArrayByPath(currentJsonData, path, newField);\n          renderCurrentEditMode();\n        });\n      });\n    }\n\n    // Path utilities for nested object manipulation\n    function getValueByPath(obj, path) {\n      const parts = path.split('.');\n      let current = obj;\n      for (const part of parts) {\n        if (current === null || current === undefined) return undefined;\n        current = current[part];\n      }\n      return current;\n    }\n\n    function setValueByPath(obj, path, value) {\n      const parts = path.split('.');\n      let current = obj;\n      for (let i = 0; i < parts.length - 1; i++) {\n        const part = parts[i];\n        if (current[part] === undefined) {\n          current[part] = isNaN(parseInt(parts[i + 1])) ? {} : [];\n        }\n        current = current[part];\n      }\n      current[parts[parts.length - 1]] = value;\n    }\n\n    function deleteByPath(obj, path) {\n      const parts = path.split('.');\n      let current = obj;\n      for (let i = 0; i < parts.length - 1; i++) {\n        current = current[parts[i]];\n        if (!current) return;\n      }\n      const lastPart = parts[parts.length - 1];\n      if (Array.isArray(current)) {\n        current.splice(parseInt(lastPart), 1);\n      } else {\n        delete current[lastPart];\n      }\n    }\n\n    function addToArrayByPath(obj, path, value) {\n      const arr = getValueByPath(obj, path);\n      if (Array.isArray(arr)) {\n        arr.push(value);\n      }\n    }\n\n    // Save node to API using the direct knowledge graph update endpoint\n    async function saveNode() {\n      const n = nodes[currentIndex];\n      const isYouTube = isYouTubeNode(n);\n      const isFulltext = isFulltextNode(n);\n\n      // Validate we have data to save\n      if (!isYouTube && !isFulltext && !currentJsonData) {\n        setEditStatus('No data to save.', 'error');\n        return;\n      }\n\n      if (!isSuperadmin()) {\n        setEditStatus('Only Superadmin can save changes.', 'error');\n        return;\n      }\n\n      const nodeId = n.id;\n\n      setEditStatus('Saving...', 'saving');\n\n      try {\n        // Step 1: Fetch the full graph data\n        setEditStatus('Loading graph...', 'saving');\n        const graphRes = await fetch('https://knowledge.vegvisr.org/getknowgraph?id=' + encodeURIComponent(GRAPH_ID));\n        if (!graphRes.ok) {\n          throw new Error('Failed to fetch graph: ' + graphRes.status);\n        }\n        const graphData = await graphRes.json();\n\n        // Step 2: Find and update the target node in the graph\n        const allNodes = Array.isArray(graphData.nodes) ? graphData.nodes : [];\n        const targetNodeIndex = allNodes.findIndex(node => node.id === nodeId);\n\n        if (targetNodeIndex === -1) {\n          throw new Error('Node not found in graph');\n        }\n\n        // Handle YouTube node vs fulltext node vs regular JSON node\n        if (isYouTube) {\n          // Get data from YouTube edit form\n          const youtubeData = getYouTubeEditData();\n\n          // Validate YouTube URL\n          const videoId = extractYouTubeVideoId(youtubeData.path);\n          if (!videoId) {\n            setEditStatus('Please enter a valid YouTube URL.', 'error');\n            return;\n          }\n\n          // Update node fields\n          allNodes[targetNodeIndex].path = youtubeData.path;\n          allNodes[targetNodeIndex].info = youtubeData.info;\n\n          // Also update bibl array if it exists\n          if (Array.isArray(allNodes[targetNodeIndex].bibl)) {\n            allNodes[targetNodeIndex].bibl[0] = youtubeData.path;\n          } else {\n            allNodes[targetNodeIndex].bibl = [youtubeData.path];\n          }\n\n          // Update local node reference\n          n.path = youtubeData.path;\n          n.info = youtubeData.info;\n          n.bibl = allNodes[targetNodeIndex].bibl;\n\n        } else if (isFulltextNode(n)) {\n          // Fulltext node - save the markdown content directly\n          const fulltextData = getFulltextEditData();\n\n          if (!fulltextData.info || !fulltextData.info.trim()) {\n            setEditStatus('Content cannot be empty.', 'error');\n            return;\n          }\n\n          // Update node's info field\n          allNodes[targetNodeIndex].info = fulltextData.info;\n\n          // Update local node reference\n          n.info = fulltextData.info;\n\n        } else {\n          // Regular JSON node - add timestamp and editor info\n          currentJsonData.updatedAt = new Date().toISOString();\n          currentJsonData.updatedBy = currentUser.email || currentUser.username || currentUser.id;\n\n          // Update the node's info field with the new JSON content\n          allNodes[targetNodeIndex].info = JSON.stringify(currentJsonData, null, 2);\n\n          // Update local node reference\n          n.info = JSON.stringify(currentJsonData, null, 2);\n        }\n\n        // Step 3: Save the updated graph back\n        setEditStatus('Updating graph...', 'saving');\n        const updateRes = await fetch('https://knowledge.vegvisr.org/updateknowgraph', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({\n            id: GRAPH_ID,\n            graphData: {\n              nodes: allNodes,\n              edges: graphData.edges || []\n            }\n          })\n        });\n\n        if (!updateRes.ok) {\n          const errorData = await updateRes.json().catch(() => ({}));\n          throw new Error(errorData.error || errorData.message || 'Failed to update graph: ' + updateRes.status);\n        }\n\n        setEditStatus('Saved successfully!', 'saved');\n\n        // Exit edit mode after a short delay\n        setTimeout(() => {\n          toggleEditMode(false);\n        }, 1500);\n\n      } catch (err) {\n        console.error('Save error:', err);\n        setEditStatus('Error: ' + err.message, 'error');\n      }\n    }\n\n    // Parse Vegvisr special elements in content\n    function parseVegvisrElements(html) {\n      // Work notes\n      html = html.replace(/\\\\[WNOTE\\\\s*\\\\|([^\\\\]]*)\\\\]([\\\\s\\\\S]*?)\\\\[END\\\\s+WNOTE\\\\]/gi, (m, params, content) => {\n        const cited = params.match(/Cited\\\\s*=\\\\s*['\"]?([^'\"\\\\];]+)/i)?.[1] || '';\n        return \\`<div class=\"work-note\">\\${marked.parse(content.trim())}\\${cited ? \\`<cite>\u2014 \\${cited}</cite>\\` : ''}</div>\\`;\n      });\n      // Quotes\n      html = html.replace(/\\\\[QUOTE\\\\s*\\\\|([^\\\\]]*)\\\\]([\\\\s\\\\S]*?)\\\\[END\\\\s+QUOTE\\\\]/gi, (m, params, content) => {\n        const cited = params.match(/Cited\\\\s*=\\\\s*['\"]?([^'\"\\\\];]+)/i)?.[1] || '';\n        return \\`<div class=\"fancy-quote\">\\${marked.parse(content.trim())}\\${cited ? \\`<cite>\u2014 \\${cited}</cite>\\` : ''}</div>\\`;\n      });\n      // Sections\n      html = html.replace(/\\\\[SECTION\\\\s*\\\\|([^\\\\]]*)\\\\]([\\\\s\\\\S]*?)\\\\[END\\\\s+SECTION\\\\]/gi, (m, style, content) => {\n        return \\`<div class=\"section\" style=\"\\${style}\">\\${marked.parse(content.trim())}</div>\\`;\n      });\n      // Fancy titles\n      html = html.replace(/\\\\[FANCY\\\\s*\\\\|([^\\\\]]*)\\\\]([\\\\s\\\\S]*?)\\\\[END\\\\s+FANCY\\\\]/gi, (m, params, content) => {\n        const bgMatch = params.match(/background\\\\s*=\\\\s*['\"]?([^'\"\\\\];]+)/i);\n        const bg = bgMatch ? bgMatch[1] : '';\n        const style = bg ? \\`background-image: url('\\${bg}');\\` : '';\n        return \\`<div class=\"fancy-title\" style=\"\\${style}\">\\${marked.parse(content.trim())}</div>\\`;\n      });\n      // Image quotes\n      html = html.replace(/\\\\[IMAGEQUOTE\\\\s*\\\\|([^\\\\]]*)\\\\]([\\\\s\\\\S]*?)\\\\[END\\\\s+IMAGEQUOTE\\\\]/gi, (m, params, content) => {\n        const bgMatch = params.match(/background\\\\s*=\\\\s*['\"]?([^'\"\\\\];]+)/i);\n        const citedMatch = params.match(/Cited\\\\s*=\\\\s*['\"]?([^'\"\\\\];]+)/i);\n        const bg = bgMatch ? bgMatch[1] : '';\n        const cited = citedMatch ? citedMatch[1] : '';\n        const style = bg ? \\`background-image: url('\\${bg}');\\` : '';\n        return \\`<div class=\"imagequote-element\" style=\"\\${style}\">\n          <div class=\"imagequote-content\">\\${marked.parse(content.trim())}</div>\n          \\${cited ? \\`<div class=\"imagequote-citation\">\u2014 \\${cited}</div>\\` : ''}\n        </div>\\`;\n      });\n      // Images - support [IMAGE](url) syntax\n      html = html.replace(/\\\\[IMAGE\\\\]\\\\(([^\\\\)]+)\\\\)/gi, (m, url) => {\n        return \\`<img src=\"\\${url}\" alt=\"Image\" style=\"max-width: 100%; border-radius: 12px; border: 1px solid rgba(255,255,255,0.10); margin: 16px 0;\" />\\`;\n      });\n      return html;\n    }\n\n    // ========== YOUTUBE VIDEO FUNCTIONS ==========\n\n    /**\n     * Extract YouTube video ID from various URL formats:\n     * - https://www.youtube.com/watch?v=VIDEO_ID\n     * - https://youtu.be/VIDEO_ID\n     * - https://www.youtube.com/embed/VIDEO_ID\n     * - https://www.youtube.com/v/VIDEO_ID\n     * - https://youtu.be/VIDEO_ID?si=TRACKING_PARAM\n     */\n    function extractYouTubeVideoId(url) {\n      if (!url || typeof url !== 'string') return null;\n\n      const patterns = [\n        // youtu.be/VIDEO_ID or youtu.be/VIDEO_ID?si=xxx\n        /youtu\\\\.be\\\\/([a-zA-Z0-9_-]{11})/,\n        // youtube.com/watch?v=VIDEO_ID\n        /youtube\\\\.com\\\\/watch\\\\?v=([a-zA-Z0-9_-]{11})/,\n        // youtube.com/embed/VIDEO_ID\n        /youtube\\\\.com\\\\/embed\\\\/([a-zA-Z0-9_-]{11})/,\n        // youtube.com/v/VIDEO_ID\n        /youtube\\\\.com\\\\/v\\\\/([a-zA-Z0-9_-]{11})/,\n        // youtube.com/shorts/VIDEO_ID\n        /youtube\\\\.com\\\\/shorts\\\\/([a-zA-Z0-9_-]{11})/,\n        // Just the video ID (11 characters)\n        /^([a-zA-Z0-9_-]{11})$/\n      ];\n\n      for (const pattern of patterns) {\n        const match = url.match(pattern);\n        if (match && match[1]) {\n          return match[1];\n        }\n      }\n\n      return null;\n    }\n\n    /**\n     * Get YouTube video URL from a node\n     * Checks: path, bibl array, info field\n     */\n    function getYouTubeUrlFromNode(node) {\n      if (!node) return null;\n\n      // Check path field first (most likely location)\n      if (node.path) {\n        const videoId = extractYouTubeVideoId(node.path);\n        if (videoId) return { url: node.path, videoId };\n      }\n\n      // Check bibl array\n      if (Array.isArray(node.bibl)) {\n        for (const url of node.bibl) {\n          const videoId = extractYouTubeVideoId(url);\n          if (videoId) return { url, videoId };\n        }\n      }\n\n      // Check info field for YouTube URLs\n      if (node.info && typeof node.info === 'string') {\n        const urlMatch = node.info.match(/https?:\\\\/\\\\/(?:www\\\\.)?(?:youtube\\\\.com|youtu\\\\.be)[^\\\\s\"'<>]+/i);\n        if (urlMatch) {\n          const videoId = extractYouTubeVideoId(urlMatch[0]);\n          if (videoId) return { url: urlMatch[0], videoId };\n        }\n      }\n\n      return null;\n    }\n\n    /**\n     * Render a YouTube video node as an embedded iframe\n     */\n    function renderYouTubeNode(node) {\n      const videoData = getYouTubeUrlFromNode(node);\n\n      if (!videoData || !videoData.videoId) {\n        return \\`\n          <div class=\"youtube-error\">\n            <p>\u26A0\uFE0F Could not find a valid YouTube video URL in this node.</p>\n            <code>Check the node's \"path\" or \"bibl\" fields for a YouTube link.</code>\n          </div>\n        \\`;\n      }\n\n      const embedUrl = \\`https://www.youtube.com/embed/\\${videoData.videoId}?rel=0\\`;\n      const watchUrl = \\`https://www.youtube.com/watch?v=\\${videoData.videoId}\\`;\n\n      // Get description from info field\n      const description = node.info && typeof node.info === 'string' ? node.info.trim() : '';\n\n      let html = \\`\n        <div class=\"youtube-embed-container\">\n          <iframe\n            src=\"\\${embedUrl}\"\n            title=\"\\${escapeHtml(node.label || 'YouTube Video')}\"\n            allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\"\n            allowfullscreen\n          ></iframe>\n        </div>\n      \\`;\n\n      // Add video info section if there's a description\n      if (description && !description.includes(videoData.url)) {\n        html += \\`\n          <div class=\"youtube-video-info\">\n            <p>\\${marked.parse(description)}</p>\n          </div>\n        \\`;\n      }\n\n      // Add link to watch on YouTube\n      html += \\`\n        <a href=\"\\${watchUrl}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"youtube-video-link\">\n          <svg viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n            <path d=\"M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z\"/>\n          </svg>\n          Watch on YouTube\n        </a>\n      \\`;\n\n      return html;\n    }\n\n    /**\n     * Render a YouTube video node in edit mode\n     */\n    function renderYouTubeNodeEditable(node) {\n      const videoData = getYouTubeUrlFromNode(node);\n      const currentUrl = node.path || (Array.isArray(node.bibl) && node.bibl[0]) || '';\n      const description = node.info && typeof node.info === 'string' ? node.info.trim() : '';\n      const videoId = videoData ? videoData.videoId : null;\n\n      let previewHtml = '';\n      if (videoId) {\n        const embedUrl = \\`https://www.youtube.com/embed/\\${videoId}?rel=0\\`;\n        previewHtml = \\`<iframe src=\"\\${embedUrl}\" title=\"Preview\" allowfullscreen></iframe>\\`;\n      } else {\n        previewHtml = \\`<div class=\"youtube-preview-placeholder\">Enter a valid YouTube URL to see preview</div>\\`;\n      }\n\n      return \\`\n        <div class=\"youtube-edit-form\">\n          <div class=\"youtube-edit-field\">\n            <label for=\"youtube-url-input\">YouTube Video URL</label>\n            <input\n              type=\"url\"\n              id=\"youtube-url-input\"\n              value=\"\\${escapeHtml(currentUrl)}\"\n              placeholder=\"https://youtu.be/VIDEO_ID or https://youtube.com/watch?v=VIDEO_ID\"\n            >\n            <div class=\"field-help\">Supports: youtu.be, youtube.com/watch, youtube.com/embed, youtube.com/shorts</div>\n            <div id=\"youtube-url-status\" class=\"youtube-url-status \\${videoId ? 'valid' : 'invalid'}\">\n              \\${videoId ? '\u2713 Valid YouTube URL (Video ID: ' + videoId + ')' : '\u2717 Enter a valid YouTube URL'}\n            </div>\n          </div>\n\n          <div class=\"youtube-edit-field\">\n            <label>Video Preview</label>\n            <div id=\"youtube-preview-container\" class=\"youtube-preview-small\">\n              \\${previewHtml}\n            </div>\n          </div>\n\n          <div class=\"youtube-edit-field\">\n            <label for=\"youtube-description-input\">Description</label>\n            <textarea\n              id=\"youtube-description-input\"\n              placeholder=\"Add a description for this video...\"\n            >\\${escapeHtml(description)}</textarea>\n            <div class=\"field-help\">This text appears below the video. Markdown is supported.</div>\n          </div>\n        </div>\n      \\`;\n    }\n\n    /**\n     * Attach event handlers for YouTube edit mode\n     */\n    function attachYouTubeEditHandlers() {\n      const urlInput = document.getElementById('youtube-url-input');\n      const statusEl = document.getElementById('youtube-url-status');\n      const previewContainer = document.getElementById('youtube-preview-container');\n\n      if (urlInput) {\n        urlInput.addEventListener('input', function() {\n          const url = this.value.trim();\n          const videoId = extractYouTubeVideoId(url);\n\n          if (videoId) {\n            statusEl.className = 'youtube-url-status valid';\n            statusEl.textContent = '\u2713 Valid YouTube URL (Video ID: ' + videoId + ')';\n\n            // Update preview\n            const embedUrl = \\`https://www.youtube.com/embed/\\${videoId}?rel=0\\`;\n            previewContainer.innerHTML = \\`<iframe src=\"\\${embedUrl}\" title=\"Preview\" allowfullscreen></iframe>\\`;\n          } else if (url) {\n            statusEl.className = 'youtube-url-status invalid';\n            statusEl.textContent = '\u2717 Could not extract video ID from URL';\n            previewContainer.innerHTML = \\`<div class=\"youtube-preview-placeholder\">Invalid YouTube URL</div>\\`;\n          } else {\n            statusEl.className = 'youtube-url-status invalid';\n            statusEl.textContent = '\u2717 Enter a valid YouTube URL';\n            previewContainer.innerHTML = \\`<div class=\"youtube-preview-placeholder\">Enter a valid YouTube URL to see preview</div>\\`;\n          }\n        });\n      }\n    }\n\n    /**\n     * Get YouTube edit data from form\n     */\n    function getYouTubeEditData() {\n      const urlInput = document.getElementById('youtube-url-input');\n      const descInput = document.getElementById('youtube-description-input');\n\n      return {\n        path: urlInput ? urlInput.value.trim() : '',\n        info: descInput ? descInput.value.trim() : ''\n      };\n    }\n\n    /**\n     * Render fulltext node as editable textarea\n     */\n    function renderFulltextNodeEditable(node) {\n      const content = node.info && typeof node.info === 'string' ? node.info.trim() : '';\n      const label = node.label || 'Untitled';\n\n      return \\`\n        <div class=\"fulltext-edit-form\">\n          <div class=\"fulltext-edit-field\">\n            <label for=\"fulltext-content-input\">Content (Markdown supported)</label>\n            <textarea\n              id=\"fulltext-content-input\"\n              placeholder=\"Enter your content here. Markdown is fully supported.\"\n              class=\"fulltext-textarea\"\n            >\\${escapeHtml(content)}</textarea>\n            <div class=\"field-help\">\n              Supports Markdown: headings, bold, italic, links, tables, code blocks, lists, blockquotes, etc.\n            </div>\n          </div>\n\n          <div class=\"fulltext-preview-field\">\n            <label>Live Preview</label>\n            <div id=\"fulltext-preview\" class=\"previewPanel\">\n              \\${content ? marked.parse(content) : '<em>Preview will appear here...</em>'}\n            </div>\n          </div>\n        </div>\n      \\`;\n    }\n\n    /**\n     * Attach event handlers for fulltext edit mode\n     */\n    function attachFulltextEditHandlers() {\n      const textarea = document.getElementById('fulltext-content-input');\n      const preview = document.getElementById('fulltext-preview');\n\n      if (textarea && preview) {\n        // Update preview on input\n        textarea.addEventListener('input', function() {\n          const content = this.value;\n          try {\n            let html = content ? marked.parse(content) : '<em>Preview will appear here...</em>';\n            html = parseVegvisrElements(html);\n            preview.innerHTML = html;\n          } catch (e) {\n            console.error('Markdown parse error:', e);\n            preview.innerHTML = '<div class=\"error\">Error parsing markdown</div>';\n          }\n        });\n\n        // Auto-resize textarea\n        textarea.addEventListener('input', function() {\n          this.style.height = 'auto';\n          this.style.height = Math.min(this.scrollHeight, 600) + 'px';\n        });\n\n        // Trigger initial resize\n        textarea.dispatchEvent(new Event('input'));\n      }\n    }\n\n    /**\n     * Get fulltext edit data from form\n     */\n    function getFulltextEditData() {\n      const textarea = document.getElementById('fulltext-content-input');\n      return {\n        info: textarea ? textarea.value.trim() : ''\n      };\n    }\n\n    /**\n     * Check if a node is a YouTube video node\n     */\n    function isYouTubeNode(node) {\n      if (!node) return false;\n\n      // Check explicit type\n      const nodeType = (node.type || '').toLowerCase();\n      if (nodeType === 'youtube-video' || nodeType === 'youtube' || nodeType === 'video') {\n        return true;\n      }\n\n      // Check if path contains YouTube URL\n      if (node.path && extractYouTubeVideoId(node.path)) {\n        return true;\n      }\n\n      // Check bibl array for YouTube URLs\n      if (Array.isArray(node.bibl)) {\n        for (const url of node.bibl) {\n          if (extractYouTubeVideoId(url)) {\n            return true;\n          }\n        }\n      }\n\n      return false;\n    }\n\n    function isFulltextNode(node) {\n      if (!node) return false;\n\n      // Check explicit type\n      const nodeType = (node.type || '').toLowerCase();\n      if (nodeType === 'fulltext' || nodeType === 'fulltext-node' || nodeType === 'text' || nodeType === 'markdown') {\n        return true;\n      }\n\n      // If it has info content but is NOT JSON and NOT YouTube, it's fulltext\n      const info = normalizeStr(node.info);\n      if (info && info.trim()) {\n        // Check if it's NOT JSON\n        if (!extractJsonFromInfo(info)) {\n          // And NOT YouTube\n          if (!isYouTubeNode(node)) {\n            return true;\n          }\n        }\n      }\n\n      return false;\n    }\n\n    function setText(id, text) {\n      const el = document.getElementById(id);\n      if (el) el.textContent = text;\n    }\n\n    function setHTML(id, html) {\n      const el = document.getElementById(id);\n      if (el) el.innerHTML = html;\n    }\n\n    function normalizeStr(x) {\n      return String(x ?? '');\n    }\n\n    function nodeMatches(n) {\n      const label = normalizeStr(n && n.label);\n      return label.toLowerCase().includes(LABEL_CONTAINS.toLowerCase());\n    }\n\n    function buildPills() {\n      const wrap = document.getElementById('stepPills');\n      wrap.innerHTML = '';\n\n      if (!nodes.length) {\n        wrap.innerHTML = \\`<div class=\"soft text-sm\">No nodes whose label contains <code>\\${LABEL_CONTAINS}</code> found.</div>\\`;\n        return;\n      }\n\n      nodes.forEach((n, idx) => {\n        const pill = document.createElement('div');\n        pill.className = 'pill' + (idx === currentIndex ? ' pillActive' : '');\n        // pill text = label, but fallback to id\n        pill.textContent = n.label || n.id || ('Node ' + (idx + 1));\n        pill.title = \\`\\${n.label || ''}\\\\n(id: \\${n.id || '\u2014'})\\`;\n        pill.onclick = () => {\n          if (editMode) {\n            if (!confirm('Discard changes and switch node?')) return;\n            toggleEditMode(false);\n          }\n          currentIndex = idx;\n          renderCurrent();\n        };\n        wrap.appendChild(pill);\n      });\n\n      // === NEW: Also build sidebar pills if in sidebar mode ===\n      if (nodesLayoutMode === 'sidebar') {\n        buildSidebarPills();\n      }\n      // === END NEW ===\n    }\n\n    function updatePillsActive() {\n      document.querySelectorAll('#stepPills .pill').forEach((el, idx) => {\n        el.classList.toggle('pillActive', idx === currentIndex);\n      });\n    }\n\n    function setView(mode) {\n      viewMode = mode;\n\n      const uiView = document.getElementById('uiView');\n      const jsonView = document.getElementById('jsonView');\n      const btn = document.getElementById('btnToggleView');\n\n      const showUI = (viewMode === 'ui');\n      uiView.classList.toggle('hidden', !showUI);\n      jsonView.classList.toggle('hidden', showUI);\n\n      btn.textContent = showUI ? 'Show JSON' : 'Show UI';\n    }\n\n    function renderCurrent() {\n      const btnPrev = document.getElementById('btnPrev');\n      const btnNext = document.getElementById('btnNext');\n\n      if (!nodes.length) {\n        setText('nodeMeta', 'No matching nodes');\n        setText('nodeTitle', 'Nothing to display');\n        setHTML('nodeIntro', '');\n        setHTML('nodePreview', \\`<div class=\"soft text-sm\">This graph contains no nodes whose label contains <code>\\${LABEL_CONTAINS}</code>.</div>\\`);\n        document.getElementById('jsonView').textContent = '';\n        btnPrev.disabled = true;\n        btnNext.disabled = true;\n\n        const dbg = { currentIndex, labelContains: LABEL_CONTAINS, nodesShown: 0 };\n        document.getElementById('debug').textContent = JSON.stringify(dbg, null, 2);\n        return;\n      }\n\n      const n = nodes[currentIndex];\n      setText('nodeMeta', '');\n      const meta2El = document.getElementById('nodeMeta2');\n      if (meta2El) meta2El.textContent = \\`\\${currentIndex + 1} / \\${nodes.length}\\`;\n      setText('nodeTitle', n.label || n.id || 'Untitled');\n\n      // UI preview content\n      const info = normalizeStr(n.info);\n      let rendered = '';\n\n      // Check if this is a YouTube video node first\n      if (isYouTubeNode(n)) {\n        rendered = renderYouTubeNode(n);\n      } else if (info && info.trim()) {\n        // First, try to extract and render JSON as UI\n        const jsonData = extractJsonFromInfo(info);\n\n        if (jsonData) {\n          // Render JSON as interactive UI\n          const uiHtml = renderJsonAsUI(jsonData);\n          if (uiHtml) {\n            rendered = uiHtml;\n          } else {\n            // Fallback to markdown if UI rendering fails\n            const markdownHTML = marked.parse(info);\n            rendered = parseVegvisrElements(markdownHTML);\n          }\n        } else {\n          // Not JSON, render as markdown with Vegvisr elements\n          const markdownHTML = marked.parse(info);\n          rendered = parseVegvisrElements(markdownHTML);\n        }\n      } else {\n        rendered = '<div class=\"soft text-sm\">No content (node.info is empty).</div>';\n      }\n\n      setHTML('nodeIntro', '');\n      setHTML('nodePreview', rendered);\n\n      // Attach click handlers for choice cards\n      attachChoiceCardHandlers();\n\n      // JSON view content - show both raw info and parsed JSON if available\n      const jsonData = extractJsonFromInfo(info);\n      const jsonViewContent = {\n        node: n,\n        parsedJson: jsonData || '(No JSON found in info field)'\n      };\n      document.getElementById('jsonView').textContent = JSON.stringify(jsonViewContent, null, 2);\n\n      btnPrev.disabled = (currentIndex === 0);\n      btnNext.disabled = (currentIndex === nodes.length - 1);\n\n      updatePillsActive();\n\n      // === NEW: Also update sidebar pills ===\n      if (nodesLayoutMode === 'sidebar') {\n        updateSidebarPillsActive();\n      }\n      // === END NEW ===\n\n      const dbg = {\n        currentIndex,\n        labelContains: LABEL_CONTAINS,\n        nodeId: n.id,\n        nodeLabel: n.label,\n        hasInfo: Boolean(n.info && String(n.info).trim()),\n        hasJsonInInfo: Boolean(jsonData),\n        node: n\n      };\n      document.getElementById('debug').textContent = JSON.stringify(dbg, null, 2);\n    }\n\n    async function loadGraph() {\n      setText('graphIdLabel', GRAPH_ID);\n      const graphIdCodeEl = document.getElementById('graphIdCode');\n      if (graphIdCodeEl) graphIdCodeEl.textContent = GRAPH_ID;\n\n      const res = await fetch('https://knowledge.vegvisr.org/getknowgraph?id=' + encodeURIComponent(GRAPH_ID));\n      if (!res.ok) throw new Error('Failed to fetch graph: ' + res.status);\n\n      const data = await res.json();\n      const allNodes = Array.isArray(data.nodes) ? data.nodes.slice() : [];\n\n      // Find the first markdown-image node to use as the header image\n      const imgNode = allNodes.find(n => n.type === 'markdown-image');\n      if (imgNode) {\n        headerImageNode = imgNode;\n        let imgUrl = imgNode.path || '';\n        if (!imgUrl && imgNode.info) {\n          const match = imgNode.info.match(/!\\[[^\\]]*\\]\\(([^)]+)\\)/);\n          if (match) imgUrl = match[1];\n        }\n        const headerImg = document.getElementById('headerImage');\n        if (headerImg && imgUrl) {\n          headerImg.src = imgUrl;\n          headerImg.style.display = '';\n        }\n      }\n\n      // Filter: label contains \"NODE\" (case-insensitive)\n      nodes = allNodes.filter(nodeMatches);\n\n      // Optional: stable sort if \"order\" exists\n      nodes.sort((a, b) => {\n        const ao = Number.isFinite(+a?.order) ? +a.order : Number.POSITIVE_INFINITY;\n        const bo = Number.isFinite(+b?.order) ? +b.order : Number.POSITIVE_INFINITY;\n        if (ao !== bo) return ao - bo;\n        return normalizeStr(a?.label).localeCompare(normalizeStr(b?.label));\n      });\n\n      setText('discoveredCount', String(nodes.length));\n\n      currentIndex = 0;\n      buildPills();\n      renderCurrent();\n    }\n\n    document.getElementById('btnPrev').onclick = () => {\n      if (currentIndex > 0) {\n        if (editMode) {\n          if (!confirm('Discard changes and go to previous node?')) return;\n          toggleEditMode(false);\n        }\n        currentIndex--;\n        renderCurrent();\n      }\n    };\n\n    document.getElementById('btnNext').onclick = () => {\n      if (currentIndex < nodes.length - 1) {\n        if (editMode) {\n          if (!confirm('Discard changes and go to next node?')) return;\n          toggleEditMode(false);\n        }\n        currentIndex++;\n        renderCurrent();\n      }\n    };\n\n    document.getElementById('btnReload').onclick = async () => {\n      await init();\n    };\n\n    document.getElementById('btnToggleDebug').onclick = () => {\n      debugOn = !debugOn;\n      document.getElementById('debug').classList.toggle('hidden', !debugOn);\n    };\n\n    document.getElementById('btnToggleView').onclick = () => {\n      setView(viewMode === 'ui' ? 'json' : 'ui');\n    };\n\n    document.getElementById('btnEditMode').onclick = () => {\n      if (!editMode) {\n        // Verify Superadmin access\n        if (!isSuperadmin()) {\n          alert('Edit mode is only available for Superadmin users.');\n          return;\n        }\n\n        // Check if current node exists\n        const n = nodes[currentIndex];\n        if (!n) {\n          alert('No node selected.');\n          return;\n        }\n\n        // Check if node is editable (YouTube node, fulltext node, or has JSON data)\n        const isYouTube = isYouTubeNode(n);\n        const isFulltext = isFulltextNode(n);\n        if (!isYouTube && !isFulltext) {\n          const info = normalizeStr(n.info);\n          const jsonData = extractJsonFromInfo(info);\n          if (!jsonData) {\n            alert('This node does not contain editable JSON data.');\n            return;\n          }\n        }\n\n        // Show user info in toolbar\n        const userInfo = document.getElementById('editUserInfo');\n        if (userInfo && currentUser) {\n          userInfo.textContent = \\`Editing as: \\${currentUser.email || currentUser.username || 'Superadmin'}\\`;\n        }\n\n        toggleEditMode(true);\n      }\n    };\n\n    document.getElementById('btnSaveNode').onclick = () => {\n      saveNode();\n    };\n\n    document.getElementById('btnCancelEdit').onclick = () => {\n      if (confirm('Discard changes?')) {\n        toggleEditMode(false);\n      }\n    };\n\n    // ========== HEADER IMAGE EDITING ==========\n    const btnEditHeaderImage = document.getElementById('btnEditHeaderImage');\n    const headerImageEditor = document.getElementById('headerImageEditor');\n    const headerImageUrl = document.getElementById('headerImageUrl');\n    const headerImage = document.getElementById('headerImage');\n\n    if (btnEditHeaderImage) {\n      btnEditHeaderImage.onclick = () => {\n        // Pre-fill with current image URL\n        if (headerImageUrl && headerImage) {\n          headerImageUrl.value = headerImage.src || '';\n        }\n        if (headerImageEditor) headerImageEditor.classList.remove('hidden');\n        btnEditHeaderImage.classList.add('hidden');\n      };\n    }\n\n    const btnApplyHeaderImage = document.getElementById('btnApplyHeaderImage');\n    if (btnApplyHeaderImage) {\n      btnApplyHeaderImage.onclick = async () => {\n        const newUrl = headerImageUrl ? headerImageUrl.value.trim() : '';\n        if (!newUrl) {\n          alert('Please enter an image URL.');\n          return;\n        }\n        // Update the image in the DOM\n        if (headerImage) headerImage.src = newUrl;\n        // Hide the editor\n        if (headerImageEditor) headerImageEditor.classList.add('hidden');\n        if (btnEditHeaderImage) btnEditHeaderImage.classList.remove('hidden');\n\n        // Persist the change \u2014 patch the markdown-image node's path field\n        try {\n          if (!headerImageNode || !GRAPH_ID) {\n            console.warn('No header image node found or no graph ID; cannot persist.');\n            return;\n          }\n          await fetch('https://knowledge.vegvisr.org/patchNode', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              graphId: GRAPH_ID,\n              nodeId: headerImageNode.id,\n              fields: { path: newUrl }\n            })\n          });\n          // Update local reference\n          headerImageNode.path = newUrl;\n        } catch (err) {\n          console.warn('Could not persist header image change:', err);\n        }\n      };\n    }\n\n    const btnCancelHeaderImage = document.getElementById('btnCancelHeaderImage');\n    if (btnCancelHeaderImage) {\n      btnCancelHeaderImage.onclick = () => {\n        if (headerImageEditor) headerImageEditor.classList.add('hidden');\n        if (btnEditHeaderImage) btnEditHeaderImage.classList.remove('hidden');\n      };\n    }\n\n    // Hamburger menu toggle\n    document.getElementById('hamburgerButton').onclick = () => {\n      toggleSidebar();\n    };\n\n    // Close sidebar when clicking the backdrop (touch devices only)\n    document.getElementById('sidebarBackdrop').onclick = () => {\n      if (sidebarOpen && window.matchMedia('(hover: none) and (pointer: coarse)').matches) {\n        toggleSidebar(false);\n      }\n    };\n\n    // Close sidebar when clicking outside (touch devices only)\n    document.addEventListener('click', (e) => {\n      if (!window.matchMedia('(hover: none) and (pointer: coarse)').matches) {\n        return;\n      }\n      if (sidebarOpen && nodesLayoutMode === 'sidebar') {\n        const sidebar = document.getElementById('sidebarNav');\n        const hamburger = document.getElementById('hamburgerButton');\n\n        // If click is outside sidebar and hamburger button\n        if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {\n          toggleSidebar(false);\n        }\n      }\n    });\n\n    async function init() {\n      try {\n        // Load user authentication first\n        loadUserFromStorage();\n        updateEditButtonVisibility();\n\n        setText('nodeMeta', 'Loading\u2026');\n        setText('nodeTitle', 'Loading\u2026');\n        setHTML('nodeIntro', '');\n        setHTML('nodePreview', '<div class=\"soft text-sm\">Fetching graph data\u2026</div>');\n        document.getElementById('jsonView').textContent = '';\n        setView('ui');\n        await loadGraph();\n\n        // Log authentication status for debugging\n        if (isSuperadmin()) {\n          console.log('Superadmin access granted. Edit mode available.');\n        } else {\n          console.log('User is not Superadmin or not logged in. Edit mode hidden.');\n        }\n      } catch (e) {\n        setText('nodeMeta', 'Error');\n        setText('nodeTitle', 'Could not load graph');\n        setHTML('nodeIntro', '');\n        setHTML('nodePreview', \\`<div class=\"muted text-sm\"><code>\\${String(e.message || e)}</code></div>\\`);\n        setText('discoveredCount', '\u2014');\n      }\n    }\n\n    // Listen for storage changes (e.g., login/logout in another tab)\n    window.addEventListener('storage', (e) => {\n      if (['userStore', 'user', 'currentUser', 'auth', 'token'].includes(e.key)) {\n        loadUserFromStorage();\n        updateEditButtonVisibility();\n        updateLoginButton();\n        if (editMode && !isSuperadmin()) {\n          // User logged out or lost Superadmin role - exit edit mode\n          toggleEditMode(false);\n        }\n      }\n    });\n\n    // ========== MAGIC LINK LOGIN ==========\n\n    // Use the same auth endpoints as photos-vegvisr and my-test-app\n    const AUTH_BASE = 'https://cookie.vegvisr.org';\n    const DASHBOARD_BASE = 'https://dashboard.vegvisr.org';\n\n    function showLoginModal() {\n      console.log('showLoginModal called');\n      const modal = document.getElementById('loginModal');\n      modal.classList.remove('hidden');\n      document.getElementById('loginEmailSection').classList.remove('hidden');\n      document.getElementById('loginCheckSection').classList.add('hidden');\n      document.getElementById('loginStatus').classList.add('hidden');\n      document.getElementById('loginEmail').value = localStorage.getItem('vegvisr_connect_email') || '';\n      document.getElementById('loginEmail').focus();\n    }\n\n    function hideLoginModal() {\n      document.getElementById('loginModal').classList.add('hidden');\n    }\n\n    function setLoginStatus(message, type = 'info') {\n      const statusEl = document.getElementById('loginStatus');\n      statusEl.textContent = message;\n      statusEl.className = 'login-status ' + type;\n      statusEl.classList.remove('hidden');\n    }\n\n    async function sendMagicLink() {\n      const email = document.getElementById('loginEmail').value.trim();\n\n      if (!email || !email.includes('@')) {\n        setLoginStatus('Please enter a valid email address.', 'error');\n        return;\n      }\n\n      const btn = document.getElementById('btnSendMagicLink');\n      btn.disabled = true;\n      btn.textContent = 'Sending...';\n\n      try {\n        // Store email for convenience\n        localStorage.setItem('vegvisr_connect_email', email);\n\n        // Build the redirect URL - this is where the user will be sent back after clicking the magic link\n        // IMPORTANT: This tells the backend to redirect back to THIS page, not to connect.vegvisr.org\n        const redirectUrl = window.location.origin + window.location.pathname;\n        console.log('Sending magic link with redirectUrl:', redirectUrl);\n\n        const response = await fetch(\\`\\${AUTH_BASE}/login/magic/send\\`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            email,\n            redirectUrl  // Tell the backend to redirect back to THIS page\n          })\n        });\n\n        const data = await response.json();\n\n        if (!response.ok) {\n          throw new Error(data.error || data.message || 'Failed to send magic link');\n        }\n\n        // Show the \"check email\" section\n        document.getElementById('loginEmailSection').classList.add('hidden');\n        document.getElementById('loginCheckSection').classList.remove('hidden');\n        document.getElementById('sentToEmail').textContent = email;\n        setLoginStatus('Magic link sent! Check your email inbox.', 'success');\n\n      } catch (err) {\n        console.error('Magic link request error:', err);\n        setLoginStatus('Error: ' + err.message, 'error');\n      } finally {\n        btn.disabled = false;\n        btn.textContent = 'Send Magic Link';\n      }\n    }\n\n    async function verifyMagicLinkToken(token) {\n      try {\n        console.log('Verifying magic link token...');\n        setLoginStatus('Verifying...', 'info');\n\n        // Use GET request with token as query parameter (as per vegvisr-ui-kit implementation)\n        const response = await fetch(\\`\\${AUTH_BASE}/login/magic/verify?token=\\${encodeURIComponent(token)}\\`, {\n          method: 'GET',\n          headers: { 'Content-Type': 'application/json' }\n        });\n\n        const data = await response.json();\n\n        if (!response.ok || !data.success) {\n          throw new Error(data.error || 'Invalid or expired magic link');\n        }\n\n        console.log('Magic link verified, email:', data.email);\n\n        // Now fetch user context from dashboard to get role info\n        let userContext = null;\n        try {\n          userContext = await fetchUserContext(data.email);\n          console.log('User context fetched:', userContext);\n        } catch (err) {\n          console.log('Could not fetch user context, using basic info:', err.message);\n          // Fallback to basic user info\n          userContext = {\n            email: data.email,\n            role: 'user',\n            user_id: data.email\n          };\n        }\n\n        // Store user and token\n        currentUser = userContext;\n        authToken = data.token || data.accessToken || null;\n\n        // Store in localStorage for persistence\n        localStorage.setItem('userStore', JSON.stringify({\n          user: currentUser,\n          token: authToken\n        }));\n\n        if (authToken) {\n          localStorage.setItem('token', authToken);\n        }\n\n        console.log('Login successful:', { email: currentUser.email, role: currentUser.role });\n\n        // Update UI\n        updateEditButtonVisibility();\n        updateVisibilityToggleButtons();\n        updateSuperadminButtonsVisibility();\n        updateLoginButton();\n        hideLoginModal();\n\n        // Clear magic token from URL (the token comes as ?magic=xxx)\n        const url = new URL(window.location.href);\n        url.searchParams.delete('magic');\n        window.history.replaceState({}, document.title, url.toString());\n\n        // Show success message\n        if (isSuperadmin()) {\n          alert('Welcome, Superadmin! Edit mode is now available.');\n        } else {\n          alert('Login successful! Note: Edit mode is only available for Superadmin users.');\n        }\n\n      } catch (err) {\n        console.error('Token verification error:', err);\n        setLoginStatus('Verification failed: ' + err.message, 'error');\n        showLoginModal();\n      }\n    }\n\n    // Fetch user context (role, user_id, etc.) from dashboard\n    // Uses the same two-step approach as photos-vegvisr:\n    // 1. /get-role to get the user's role (Superadmin, Admin, user, etc.)\n    // 2. /userdata to get the full user data\n    async function fetchUserContext(email) {\n      // Step 1: Fetch user role from dashboard\n      const roleRes = await fetch(\n        \\`\\${DASHBOARD_BASE}/get-role?email=\\${encodeURIComponent(email)}\\`,\n        {\n          method: 'GET',\n          headers: { 'Content-Type': 'application/json' }\n        }\n      );\n\n      if (!roleRes.ok) {\n        throw new Error(\\`User role unavailable (status: \\${roleRes.status})\\`);\n      }\n\n      const roleData = await roleRes.json();\n      console.log('Role data from dashboard:', roleData);\n\n      if (!roleData?.role) {\n        throw new Error('Unable to retrieve user role.');\n      }\n\n      // Step 2: Fetch full user data\n      const userDataRes = await fetch(\n        \\`\\${DASHBOARD_BASE}/userdata?email=\\${encodeURIComponent(email)}\\`,\n        {\n          method: 'GET',\n          headers: { 'Content-Type': 'application/json' }\n        }\n      );\n\n      if (!userDataRes.ok) {\n        throw new Error(\\`Unable to fetch user data (status: \\${userDataRes.status})\\`);\n      }\n\n      const userData = await userDataRes.json();\n      console.log('User data from dashboard:', userData);\n\n      // Step 3: Return combined user context (same structure as photos-vegvisr)\n      return {\n        email: email,\n        role: roleData.role,\n        user_id: userData.user_id || email,\n        emailVerificationToken: userData.emailVerificationToken || null,\n        oauth_id: userData.oauth_id || null,\n        phone: userData.phone || null,\n        phoneVerifiedAt: userData.phoneVerifiedAt || null,\n        branding: userData.branding || null,\n        profileimage: userData.profileimage || null\n      };\n    }\n\n    function updateLoginButton() {\n      const loginBtn = document.getElementById('btnLogin');\n      const logoutBtn = document.getElementById('btnLogout');\n\n      if (currentUser) {\n        // User is logged in - show email and logout button\n        loginBtn.innerHTML = \\`<span style=\"max-width: 150px; overflow: hidden; text-overflow: ellipsis;\">\\${escapeHtml(currentUser.email || 'Logged in')}\\${isSuperadmin() ? ' (Superadmin)' : ''}</span>\\`;\n        loginBtn.title = \\`Logged in as \\${currentUser.email || 'user'}\\${isSuperadmin() ? ' (Superadmin)' : ''}\\`;\n        loginBtn.onclick = null; // No action on click when logged in\n        loginBtn.style.cursor = 'default';\n        logoutBtn.classList.remove('hidden');\n      } else {\n        // User is not logged in\n        loginBtn.textContent = 'Login';\n        loginBtn.title = 'Login with magic link';\n        loginBtn.onclick = showLoginModal;\n        loginBtn.style.cursor = 'pointer';\n        logoutBtn.classList.add('hidden');\n      }\n    }\n\n    function handleLogout() {\n      if (confirm('Are you sure you want to logout?')) {\n        // Exit edit mode if active\n        if (editMode) {\n          toggleEditMode(false);\n        }\n\n        // Clear user data\n        currentUser = null;\n        authToken = null;\n\n        // Clear storage\n        localStorage.removeItem('userStore');\n        localStorage.removeItem('user');\n        localStorage.removeItem('currentUser');\n        localStorage.removeItem('token');\n        localStorage.removeItem('authToken');\n        sessionStorage.clear();\n\n        // Update UI\n        updateEditButtonVisibility();\n        updateVisibilityToggleButtons();\n        updateSuperadminButtonsVisibility();\n        updateLoginButton();\n\n        console.log('Logged out successfully');\n      }\n    }\n\n    // Login modal event listeners\n    // NOTE: btnLogin onclick is set by updateLoginButton() based on login state\n\n    document.getElementById('btnSendMagicLink').onclick = sendMagicLink;\n\n    document.getElementById('btnCancelLogin').onclick = hideLoginModal;\n\n    document.getElementById('btnResendLink').onclick = sendMagicLink;\n\n    document.getElementById('btnLogout').onclick = handleLogout;\n\n    document.getElementById('btnBackToEmail').onclick = () => {\n      document.getElementById('loginEmailSection').classList.remove('hidden');\n      document.getElementById('loginCheckSection').classList.add('hidden');\n      document.getElementById('loginStatus').classList.add('hidden');\n    };\n\n    document.getElementById('loginEmail').addEventListener('keydown', (e) => {\n      if (e.key === 'Enter') {\n        e.preventDefault();\n        sendMagicLink();\n      }\n    });\n\n    // Close modal on overlay click\n    document.getElementById('loginModal').onclick = (e) => {\n      if (e.target.id === 'loginModal') {\n        hideLoginModal();\n      }\n    };\n\n    // Check for magic link token in URL on page load\n    // The token comes as ?magic=xxx (as per vegvisr-ui-kit implementation)\n    function checkForMagicLinkToken() {\n      const urlParams = new URLSearchParams(window.location.search);\n      // Look for 'magic' parameter (the standard for vegvisr apps)\n      const token = urlParams.get('magic');\n\n      if (token) {\n        console.log('Magic link token found in URL (?magic=...), verifying...');\n        verifyMagicLinkToken(token);\n      }\n    }\n\n    // Modified init to also check for magic link token\n    async function initWithMagicLink() {\n      await init();\n      checkForMagicLinkToken();\n      updateLoginButton();\n      updateVisibilityToggleButtons();\n      updateSuperadminButtonsVisibility();\n\n      // Load and initialize visibility settings\n      await loadVisibilitySettings();\n      initializeVisibilityControls();\n\n      // === NEW: Apply initial layout ===\n      applyNodesLayout();\n      // === END NEW ===\n    }\n\n    initWithMagicLink();\n  </script>\n</body>\n</html>\n`;\n", "/**\n * Agent Worker - Autonomous Agent Execution\n *\n * Executes agents configured in agent_configs table\n * Service bindings:\n *   - KG_WORKER: knowledge-graph-worker (KG operations)\n *   - ANTHROPIC: anthropic-worker (encrypted API key LLM calls)\n */\n\nimport { EDITABLE_HTML_TEMPLATE } from './editable-template.js'\n\n/**\n * Tool executors - Call knowledge-graph-worker via service binding\n */\nasync function executeCreateGraph(input, env) {\n  // Check if graph already exists\n  const existsRes = await env.KG_WORKER.fetch(\n    `https://knowledge-graph-worker/getknowgraph?id=${encodeURIComponent(input.graphId)}`\n  )\n\n  if (existsRes.ok) {\n    const existing = await existsRes.json()\n    if (existing && existing.nodes) {\n      // Graph already exists \u2014 return it so the agent can add nodes to it\n      return {\n        graphId: input.graphId,\n        version: existing.metadata?.version || 0,\n        alreadyExists: true,\n        nodeCount: existing.nodes.length,\n        edgeCount: existing.edges?.length || 0,\n        message: `Graph \"${input.graphId}\" already exists (${existing.nodes.length} nodes). You can add nodes to it directly.`,\n        viewUrl: `https://www.vegvisr.org/gnew-viewer?graphId=${input.graphId}`\n      }\n    }\n  }\n\n  // Create new graph\n  const graphData = {\n    metadata: {\n      title: input.title,\n      description: input.description || '',\n      category: input.category || '',\n      metaArea: input.metaArea || '',\n      createdBy: input.userId || 'agent-worker',\n      version: 0,\n      userId: input.userId || 'agent-system',\n      tags: input.tags || []\n    },\n    nodes: [],\n    edges: []\n  }\n\n  const response = await env.KG_WORKER.fetch('https://knowledge-graph-worker/saveGraphWithHistory', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      id: input.graphId,\n      graphData\n    })\n  })\n\n  const data = await response.json()\n  if (!response.ok) {\n    throw new Error(data.error || `Failed to create graph (status: ${response.status})`)\n  }\n  return {\n    graphId: data.id || input.graphId,\n    version: data.newVersion || 1,\n    message: `Graph \"${input.title}\" created successfully`,\n    viewUrl: `https://www.vegvisr.org/gnew-viewer?graphId=${input.graphId}`\n  }\n}\n\nasync function executeGetContract(input, env) {\n  let contract = null\n\n  // Try agent_contracts table first\n  if (input.contractId) {\n    contract = await env.DB.prepare(\n      'SELECT * FROM agent_contracts WHERE id = ?1'\n    ).bind(input.contractId).first()\n  } else if (input.templateName) {\n    contract = await env.DB.prepare(\n      'SELECT * FROM agent_contracts WHERE name = ?1'\n    ).bind(input.templateName).first()\n  }\n\n  if (contract) {\n    let contractJson = JSON.parse(contract.contract_json)\n\n    // Resolve parent contract for composition\n    if (contract.parent_contract_id) {\n      const parent = await env.DB.prepare(\n        'SELECT contract_json FROM agent_contracts WHERE id = ?1'\n      ).bind(contract.parent_contract_id).first()\n      if (parent) {\n        const parentJson = JSON.parse(parent.contract_json)\n        // Merge: parent as base, child overrides\n        contractJson = deepMerge(parentJson, contractJson)\n      }\n    }\n\n    // Include template example if linked\n    if (contract.template_id) {\n      const template = await env.DB.prepare(\n        'SELECT name, nodes, ai_instructions FROM graphTemplates WHERE id = ?1'\n      ).bind(contract.template_id).first()\n      if (template) {\n        contractJson._templateExample = {\n          name: template.name,\n          nodes: template.nodes ? JSON.parse(template.nodes) : null\n        }\n      }\n    }\n\n    return contractJson\n  }\n\n  // Fallback: check graphTemplates.ai_instructions\n  if (input.templateName) {\n    const template = await env.DB.prepare(\n      'SELECT name, nodes, ai_instructions FROM graphTemplates WHERE name = ?1'\n    ).bind(input.templateName).first()\n    if (template && template.ai_instructions) {\n      try {\n        return JSON.parse(template.ai_instructions)\n      } catch {\n        return { rawInstructions: template.ai_instructions }\n      }\n    }\n  }\n\n  return { error: 'Contract not found' }\n}\n\n/**\n * Deep merge two objects (target overrides source)\n */\nfunction deepMerge(source, target) {\n  const result = { ...source }\n  for (const key of Object.keys(target)) {\n    if (target[key] && typeof target[key] === 'object' && !Array.isArray(target[key])\n        && source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {\n      result[key] = deepMerge(source[key], target[key])\n    } else {\n      result[key] = target[key]\n    }\n  }\n  return result\n}\n\nasync function executeCreateHtmlNode(input, env) {\n  const response = await env.KG_WORKER.fetch('https://knowledge-graph-worker/addNode', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      graphId: input.graphId,\n      node: {\n        id: input.nodeId,\n        label: input.label,\n        type: 'html-node',\n        info: input.htmlContent,\n        bibl: input.references || [],\n        position: { x: 0, y: 0 },\n        visible: true\n      }\n    })\n  })\n\n  const data = await response.json()\n  if (!response.ok) {\n    throw new Error(data.error || `Failed to add node (status: ${response.status})`)\n  }\n  return {\n    graphId: input.graphId,\n    nodeId: input.nodeId,\n    version: data.newVersion,\n    message: `HTML node \"${input.label}\" added successfully`\n  }\n}\n\n/**\n * Generic node creator \u2014 supports any node type (fulltext, image, link, video, audio, etc.)\n */\nasync function executeCreateNode(input, env) {\n  const node = {\n    id: input.nodeId,\n    label: input.label,\n    type: input.nodeType || 'fulltext',\n    info: input.content || '',\n    bibl: input.references || [],\n    position: { x: input.positionX || 0, y: input.positionY || 0 },\n    visible: true\n  }\n  // Optional fields for specific node types\n  if (input.path) node.path = input.path\n  if (input.imageWidth) node.imageWidth = input.imageWidth\n  if (input.imageHeight) node.imageHeight = input.imageHeight\n  if (input.color) node.color = input.color\n  if (input.metadata) node.metadata = input.metadata\n\n  const response = await env.KG_WORKER.fetch('https://knowledge-graph-worker/addNode', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ graphId: input.graphId, node })\n  })\n\n  const data = await response.json()\n  if (!response.ok) {\n    throw new Error(data.error || `Failed to add node (status: ${response.status})`)\n  }\n  return {\n    graphId: input.graphId,\n    nodeId: input.nodeId,\n    nodeType: node.type,\n    version: data.newVersion,\n    message: `Node \"${input.label}\" (${node.type}) added successfully`\n  }\n}\n\n/**\n * Add edge between two nodes in a graph\n */\nasync function executeAddEdge(input, env) {\n  // Read graph, add edge, save back\n  const getRes = await env.KG_WORKER.fetch(\n    `https://knowledge-graph-worker/getknowgraph?id=${encodeURIComponent(input.graphId)}`\n  )\n  const graphData = await getRes.json()\n  if (!getRes.ok || !graphData.nodes) {\n    throw new Error(graphData.error || 'Graph not found')\n  }\n\n  const edgeId = `${input.sourceId}_${input.targetId}`\n  const existingEdge = graphData.edges.find(e => e.id === edgeId)\n  if (existingEdge) {\n    return { graphId: input.graphId, edgeId, message: 'Edge already exists' }\n  }\n\n  graphData.edges.push({\n    id: edgeId,\n    source: input.sourceId,\n    target: input.targetId,\n    label: input.label || ''\n  })\n\n  const saveRes = await env.KG_WORKER.fetch('https://knowledge-graph-worker/saveGraphWithHistory', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      id: input.graphId,\n      graphData,\n      override: true\n    })\n  })\n\n  const saveData = await saveRes.json()\n  if (!saveRes.ok) {\n    throw new Error(saveData.error || `Failed to save edge (status: ${saveRes.status})`)\n  }\n  return {\n    graphId: input.graphId,\n    edgeId,\n    version: saveData.newVersion,\n    message: `Edge ${input.sourceId} \u2192 ${input.targetId} added`\n  }\n}\n\n/**\n * Get the editable HTML template info (placeholders only \u2014 template is too large to return to agent)\n */\nasync function executeGetHtmlTemplate(input, env) {\n  let contractInfo = null\n  if (input.contractId) {\n    const row = await env.DB.prepare(\n      'SELECT contract_json FROM agent_contracts WHERE id = ?1'\n    ).bind(input.contractId).first()\n    if (row) {\n      contractInfo = JSON.parse(row.contract_json)\n    }\n  }\n\n  return {\n    templateSize: EDITABLE_HTML_TEMPLATE.length,\n    placeholders: {\n      '{{TITLE}}': 'Page title (in <title>, h1, and img alt)',\n      '{{DESCRIPTION}}': 'Page description/subtitle shown below the title',\n      '{{HEADER_IMAGE}}': 'URL for the header image',\n      '{{FOOTER_TEXT}}': 'Footer text content',\n      '{{GRAPH_ID_DEFAULT}}': 'Fallback graph ID ({{GRAPH_ID}} is replaced at publish time)'\n    },\n    instructions: 'Use create_html_from_template to create the HTML node. Pass the placeholder values and the worker fills them into the template server-side. CSS must be created as a SEPARATE css-node.',\n    contractInfo\n  }\n}\n\n/**\n * Create an HTML node from the editable template with placeholder values filled in server-side\n */\nasync function executeCreateHtmlFromTemplate(input, env) {\n  // Fill in placeholders\n  let html = EDITABLE_HTML_TEMPLATE\n  html = html.replaceAll('{{TITLE}}', input.title || 'Untitled')\n  html = html.replaceAll('{{DESCRIPTION}}', input.description || '')\n  html = html.replaceAll('{{FOOTER_TEXT}}', input.footerText || '')\n  html = html.replaceAll('{{GRAPH_ID_DEFAULT}}', input.graphId || '')\n\n  // Create the html-node via KG worker\n  const nodeId = input.nodeId || `html-node-${Date.now()}`\n  const response = await env.KG_WORKER.fetch('https://knowledge-graph-worker/addNode', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      graphId: input.graphId,\n      node: {\n        id: nodeId,\n        label: input.title || 'Untitled Page',\n        type: 'html-node',\n        info: html,\n        bibl: [],\n        position: { x: 0, y: 0 },\n        visible: true\n      }\n    })\n  })\n\n  const data = await response.json()\n  if (!response.ok) {\n    throw new Error(data.error || `Failed to create HTML node (status: ${response.status})`)\n  }\n\n  // Create content nodes from sections array\n  // The html-node page discovers nodes whose label starts with '#'\n  const createdSections = []\n  if (Array.isArray(input.sections) && input.sections.length > 0) {\n    for (let i = 0; i < input.sections.length; i++) {\n      const section = input.sections[i]\n      const sectionTitle = section.title || `Section ${i + 1}`\n      const sectionContent = section.content || ''\n      const sectionId = `section-${i + 1}-${Date.now()}`\n\n      const sectionRes = await env.KG_WORKER.fetch('https://knowledge-graph-worker/addNode', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          graphId: input.graphId,\n          node: {\n            id: sectionId,\n            label: `# ${sectionTitle}`,\n            type: 'fulltext',\n            info: sectionContent,\n            bibl: [],\n            position: { x: 200, y: 100 + (i * 150) },\n            visible: true\n          }\n        })\n      })\n\n      if (sectionRes.ok) {\n        createdSections.push({ id: sectionId, label: `# ${sectionTitle}` })\n      }\n    }\n  }\n\n  // Create markdown-image node for header image\n  let headerImageNodeId = null\n  if (input.headerImage) {\n    headerImageNodeId = `header-image-${Date.now()}`\n    const imgRes = await env.KG_WORKER.fetch('https://knowledge-graph-worker/addNode', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        graphId: input.graphId,\n        node: {\n          id: headerImageNodeId,\n          label: 'Header Image',\n          type: 'markdown-image',\n          info: `![Header Image|width:100%;height:400px;object-fit:cover](${input.headerImage})`,\n          path: input.headerImage,\n          bibl: [],\n          position: { x: -200, y: 0 },\n          visible: true,\n          imageWidth: '1536',\n          imageHeight: '400'\n        }\n      })\n    })\n    if (!imgRes.ok) {\n      console.warn('Failed to create header image node')\n      headerImageNodeId = null\n    }\n  }\n\n  return {\n    graphId: input.graphId,\n    nodeId: nodeId,\n    version: data.newVersion,\n    htmlSize: html.length,\n    sectionsCreated: createdSections.length,\n    headerImageNodeId: headerImageNodeId,\n    message: `Editable HTML page \"${input.title}\" created (${html.length} bytes) with ${createdSections.length} content sections${headerImageNodeId ? ' and a header image node' : ''}. The page discovers nodes with # prefix labels.`,\n    viewUrl: `https://www.vegvisr.org/gnew-viewer?graphId=${input.graphId}`\n  }\n}\n\n/**\n * Execute tool by name (custom tools only \u2014 web_search is handled server-side by Claude API)\n */\nasync function executeTool(toolName, toolInput, env) {\n  switch (toolName) {\n    case 'create_graph':\n      return await executeCreateGraph(toolInput, env)\n    case 'create_html_node':\n      return await executeCreateHtmlNode(toolInput, env)\n    case 'create_node':\n      return await executeCreateNode(toolInput, env)\n    case 'add_edge':\n      return await executeAddEdge(toolInput, env)\n    case 'get_contract':\n      return await executeGetContract(toolInput, env)\n    case 'get_html_template':\n      return await executeGetHtmlTemplate(toolInput, env)\n    case 'create_html_from_template':\n      return await executeCreateHtmlFromTemplate(toolInput, env)\n    default:\n      throw new Error(`Unknown tool: ${toolName}`)\n  }\n}\n\n/**\n * Tool definitions (matching src/tools/toolDefinitions.ts)\n */\nconst TOOL_DEFINITIONS = [\n  {\n    name: 'create_graph',\n    description: 'Create a new knowledge graph with metadata. Returns the graph ID and initial version.',\n    input_schema: {\n      type: 'object',\n      properties: {\n        graphId: {\n          type: 'string',\n          description: 'UUID for the graph. Use the exact graphId provided in the task context.'\n        },\n        title: {\n          type: 'string',\n          description: 'Human-readable title for the graph'\n        },\n        description: {\n          type: 'string',\n          description: 'Detailed description of what this graph contains'\n        },\n        tags: {\n          type: 'array',\n          items: { type: 'string' },\n          description: 'Tags for categorization and discovery'\n        },\n        category: {\n          type: 'string',\n          description: 'Hashtag categories for the graph, e.g. \"#Health #Neuroscience #Biology\". Use 3-5 relevant hashtags separated by spaces.'\n        },\n        metaArea: {\n          type: 'string',\n          description: 'A single community-relevant meta area tag in ALL CAPS, e.g. \"NEUROSCIENCE\", \"AI TECHNOLOGY\", \"NORSE MYTHOLOGY\". Should be a proper noun or well-known field of study.'\n        }\n      },\n      required: ['graphId', 'title']\n    }\n  },\n  {\n    name: 'create_node',\n    description: 'Add any type of node to a knowledge graph. Use this for fulltext (markdown), image, link, video, audio, or css-node types. For html-node pages, use create_html_from_template instead. The graph must already exist (use create_graph first).',\n    input_schema: {\n      type: 'object',\n      properties: {\n        graphId: {\n          type: 'string',\n          description: 'The ID of the graph to add this node to'\n        },\n        nodeId: {\n          type: 'string',\n          description: 'Unique node ID (lowercase-kebab-case, e.g., \"node-intro\")'\n        },\n        label: {\n          type: 'string',\n          description: 'Display title for this node'\n        },\n        nodeType: {\n          type: 'string',\n          enum: ['fulltext', 'image', 'link', 'video', 'audio', 'css-node', 'html-node', 'agent-contract', 'agent-config', 'agent-run'],\n          description: 'Node type. fulltext=markdown, image=image URL, link=external URL, video=video embed, audio=audio file, css-node=CSS theme, agent-contract=contract JSON, agent-config=config JSON, agent-run=execution log JSON'\n        },\n        content: {\n          type: 'string',\n          description: 'Node content. For fulltext: markdown text. For link/video: URL. For css-node: CSS text. For image: alt text/caption.'\n        },\n        path: {\n          type: 'string',\n          description: 'File/media URL (used for image, audio node types)'\n        },\n        color: {\n          type: 'string',\n          description: 'Node color as hex (e.g., \"#7c3aed\"). Optional.'\n        },\n        metadata: {\n          type: 'object',\n          description: 'Optional metadata object. For css-node: use { \"appliesTo\": [\"html-node-id\"], \"priority\": 10 } to link CSS to an HTML node.',\n          properties: {\n            appliesTo: {\n              type: 'array',\n              items: { type: 'string' },\n              description: 'Array of node IDs this css-node applies to'\n            },\n            priority: {\n              type: 'number',\n              description: 'CSS priority (lower = higher priority). Default: 999'\n            }\n          }\n        },\n        references: {\n          type: 'array',\n          items: { type: 'string' },\n          description: 'Optional bibliography/source URLs'\n        }\n      },\n      required: ['graphId', 'nodeId', 'label', 'nodeType', 'content']\n    }\n  },\n  {\n    name: 'add_edge',\n    description: 'Connect two nodes in a knowledge graph with a directed edge. Both nodes must already exist in the graph.',\n    input_schema: {\n      type: 'object',\n      properties: {\n        graphId: {\n          type: 'string',\n          description: 'The ID of the graph containing both nodes'\n        },\n        sourceId: {\n          type: 'string',\n          description: 'The ID of the source node (edge starts here)'\n        },\n        targetId: {\n          type: 'string',\n          description: 'The ID of the target node (edge points here)'\n        },\n        label: {\n          type: 'string',\n          description: 'Optional label for the edge relationship'\n        }\n      },\n      required: ['graphId', 'sourceId', 'targetId']\n    }\n  },\n  {\n    name: 'get_contract',\n    description: 'Retrieve a contract that specifies how to generate content. The contract contains node type descriptions, templates, CSS design tokens, feature flags, validation rules, and guidelines. Always fetch the contract BEFORE generating content.',\n    input_schema: {\n      type: 'object',\n      properties: {\n        contractId: {\n          type: 'string',\n          description: 'Contract ID to fetch (e.g., \"contract_dark_glass\", \"contract_open\")'\n        },\n        templateName: {\n          type: 'string',\n          description: 'Or fetch by name (e.g., \"Dark Glass Design System\", \"Open Knowledge Graph\")'\n        }\n      }\n    }\n  },\n  {\n    name: 'create_html_from_template',\n    description: 'Create an editable HTML page from the base template with content sections. The worker creates the html-node (with CSS, login, edit mode, navigation) AND fulltext content nodes for each section. The page discovers and displays nodes whose label starts with #. No separate css-node needed.',\n    input_schema: {\n      type: 'object',\n      properties: {\n        graphId: {\n          type: 'string',\n          description: 'UUID for the graph. Use the exact graphId from the task context.'\n        },\n        title: {\n          type: 'string',\n          description: 'Page title'\n        },\n        description: {\n          type: 'string',\n          description: 'Page description/subtitle'\n        },\n        headerImage: {\n          type: 'string',\n          description: 'URL for the header image. Creates a markdown-image node in the graph that the template discovers dynamically. Use Unsplash URLs like https://images.unsplash.com/photo-ID?w=1200&h=400&fit=crop'\n        },\n        footerText: {\n          type: 'string',\n          description: 'Footer text'\n        },\n        sections: {\n          type: 'array',\n          description: 'Content sections to create as fulltext nodes. Each section becomes a navigable node in the page. Use 3-6 sections.',\n          items: {\n            type: 'object',\n            properties: {\n              title: {\n                type: 'string',\n                description: 'Section title (will be prefixed with # automatically)'\n              },\n              content: {\n                type: 'string',\n                description: 'Section content in Markdown format. Include headings, paragraphs, lists, etc.'\n              }\n            },\n            required: ['title', 'content']\n          }\n        }\n      },\n      required: ['graphId', 'title', 'sections']\n    }\n  }\n]\n\n/**\n * Claude API native web search tool (server-side \u2014 no API key needed from us)\n */\nconst WEB_SEARCH_TOOL = {\n  type: 'web_search_20250305',\n  name: 'web_search',\n  max_uses: 5\n}\n\n/**\n * Execute agent with task\n */\nasync function executeAgent(agentConfig, userTask, userId, env) {\n  // Inject default contract reference if the agent has one\n  let taskWithContract = userTask\n  if (agentConfig.default_contract_id) {\n    taskWithContract = `${userTask}\\n\\n[Default contract: ${agentConfig.default_contract_id}]`\n  }\n\n  const messages = [\n    {\n      role: 'user',\n      content: taskWithContract\n    }\n  ]\n\n  const executionLog = []\n  let turn = 0\n  const maxTurns = agentConfig.max_turns || 5\n\n  while (turn < maxTurns) {\n    turn++\n\n    executionLog.push({\n      turn,\n      type: 'agent_thinking',\n      timestamp: new Date().toISOString()\n    })\n\n    // Call anthropic-worker with userId for encrypted key retrieval\n    // Include both custom tools and Claude's native web search tool\n    const response = await env.ANTHROPIC.fetch('https://anthropic.vegvisr.org/chat', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        userId: userId,\n        messages: messages,\n        model: agentConfig.model || 'claude-haiku-4-5-20251001',\n        max_tokens: agentConfig.max_tokens || 4096,\n        temperature: agentConfig.temperature ?? 0.3,\n        system: agentConfig.system_prompt,\n        tools: [...TOOL_DEFINITIONS, WEB_SEARCH_TOOL]\n      })\n    })\n\n    const data = await response.json()\n\n    if (!response.ok) {\n      executionLog.push({\n        turn,\n        type: 'error',\n        error: data.error || 'Anthropic API error',\n        timestamp: new Date().toISOString()\n      })\n      break\n    }\n\n    // Check stop reason\n    if (data.stop_reason === 'end_turn') {\n      // Agent finished \u2014 may include web search results and citations\n      const serverSearches = data.content.filter(c => c.type === 'server_tool_use')\n      for (const search of serverSearches) {\n        executionLog.push({\n          turn,\n          type: 'web_search',\n          tool: 'web_search',\n          query: search.input?.query,\n          timestamp: new Date().toISOString()\n        })\n      }\n\n      const textContent = data.content.find(c => c.type === 'text')\n      executionLog.push({\n        turn,\n        type: 'agent_complete',\n        response: textContent ? textContent.text : '',\n        timestamp: new Date().toISOString()\n      })\n      break\n    }\n\n    if (data.stop_reason === 'tool_use') {\n      // Agent wants to use custom tools\n      // Response may also contain server_tool_use (web search) already executed by Claude API\n      const toolUses = data.content.filter(c => c.type === 'tool_use')\n      const serverSearches = data.content.filter(c => c.type === 'server_tool_use')\n\n      // Log any server-side web searches that happened\n      for (const search of serverSearches) {\n        executionLog.push({\n          turn,\n          type: 'web_search',\n          tool: 'web_search',\n          query: search.input?.query,\n          timestamp: new Date().toISOString()\n        })\n      }\n\n      if (toolUses.length > 0) {\n        executionLog.push({\n          turn,\n          type: 'tool_calls',\n          tools: toolUses.map(t => ({ name: t.name, input: t.input })),\n          timestamp: new Date().toISOString()\n        })\n      }\n\n      // Execute custom tools in parallel (web_search is already handled server-side)\n      // create_graph must run before tools that depend on it (create_html_from_template, create_node)\n      const graphTools = toolUses.filter(t => t.name === 'create_graph')\n      const otherTools = toolUses.filter(t => t.name !== 'create_graph')\n\n      // Phase 1: create_graph tools first (if any)\n      const phase1Results = await Promise.all(graphTools.map(async (toolUse) => {\n        try {\n          const result = await executeTool(toolUse.name, { ...toolUse.input, userId }, env)\n          executionLog.push({ turn, type: 'tool_result', tool: toolUse.name, success: true, result, timestamp: new Date().toISOString() })\n          return { type: 'tool_result', tool_use_id: toolUse.id, content: JSON.stringify(result) }\n        } catch (error) {\n          executionLog.push({ turn, type: 'tool_error', tool: toolUse.name, error: error.message, timestamp: new Date().toISOString() })\n          return { type: 'tool_result', tool_use_id: toolUse.id, content: JSON.stringify({ error: error.message }) }\n        }\n      }))\n\n      // Phase 2: all other tools in parallel (graph exists now)\n      const phase2Results = await Promise.all(otherTools.map(async (toolUse) => {\n        try {\n          const result = await executeTool(toolUse.name, { ...toolUse.input, userId }, env)\n          executionLog.push({ turn, type: 'tool_result', tool: toolUse.name, success: true, result, timestamp: new Date().toISOString() })\n          return { type: 'tool_result', tool_use_id: toolUse.id, content: JSON.stringify(result) }\n        } catch (error) {\n          executionLog.push({ turn, type: 'tool_error', tool: toolUse.name, error: error.message, timestamp: new Date().toISOString() })\n          return { type: 'tool_result', tool_use_id: toolUse.id, content: JSON.stringify({ error: error.message }) }\n        }\n      }))\n\n      const toolResults = [...phase1Results, ...phase2Results]\n\n      // Add to conversation\n      messages.push(\n        { role: 'assistant', content: data.content },\n        { role: 'user', content: toolResults }\n      )\n    } else if (data.stop_reason === 'pause_turn') {\n      // Claude paused a long-running turn (e.g., during web search)\n      executionLog.push({\n        turn,\n        type: 'pause_turn',\n        timestamp: new Date().toISOString()\n      })\n\n      // Log any web searches in the paused response\n      const serverSearches = data.content.filter(c => c.type === 'server_tool_use')\n      for (const search of serverSearches) {\n        executionLog.push({\n          turn,\n          type: 'web_search',\n          tool: 'web_search',\n          query: search.input?.query,\n          timestamp: new Date().toISOString()\n        })\n      }\n\n      // Continue the turn by sending the response back\n      messages.push(\n        { role: 'assistant', content: data.content },\n        { role: 'user', content: 'Continue.' }\n      )\n    } else if (data.stop_reason === 'max_tokens') {\n      // Agent hit token limit mid-response \u2014 continue the conversation\n      executionLog.push({\n        turn,\n        type: 'max_tokens_continuation',\n        timestamp: new Date().toISOString()\n      })\n\n      // Add partial response and ask agent to continue with tool calls\n      messages.push(\n        { role: 'assistant', content: data.content },\n        { role: 'user', content: 'You hit the token limit. Do NOT repeat what you already said. Continue by making your next tool call (create_node, add_edge, etc.) to finish the task.' }\n      )\n    } else {\n      // Unexpected stop reason\n      executionLog.push({\n        turn,\n        type: 'unexpected_stop',\n        stop_reason: data.stop_reason,\n        timestamp: new Date().toISOString()\n      })\n      break\n    }\n  }\n\n  if (turn >= maxTurns) {\n    executionLog.push({\n      type: 'max_turns_reached',\n      timestamp: new Date().toISOString()\n    })\n  }\n\n  return {\n    success: turn < maxTurns,\n    turns: turn,\n    executionLog: executionLog\n  }\n}\n\nexport default {\n  async fetch(request, env) {\n    const url = new URL(request.url)\n    const pathname = url.pathname\n\n    const corsHeaders = {\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods': 'GET, POST, PUT, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n      'Content-Type': 'application/json'\n    }\n\n    if (request.method === 'OPTIONS') {\n      return new Response(null, { headers: corsHeaders })\n    }\n\n    try {\n      // POST /execute - Execute an agent\n      if (pathname === '/execute' && request.method === 'POST') {\n        const body = await request.json()\n        const { agentId, task, userId, contractId, graphId } = body\n\n        if (!agentId || !task || !userId) {\n          return new Response(JSON.stringify({\n            error: 'agentId, task, and userId are required'\n          }), {\n            status: 400,\n            headers: corsHeaders\n          })\n        }\n\n        // Get agent config from D1\n        const agentConfig = await env.DB.prepare(`\n          SELECT * FROM agent_configs WHERE id = ?1 AND is_active = 1\n        `).bind(agentId).first()\n\n        if (!agentConfig) {\n          return new Response(JSON.stringify({\n            error: 'Agent not found or inactive'\n          }), {\n            status: 404,\n            headers: corsHeaders\n          })\n        }\n\n        // Parse JSON fields, allow contractId override from request\n        const config = {\n          ...agentConfig,\n          tools: JSON.parse(agentConfig.tools || '[]'),\n          metadata: JSON.parse(agentConfig.metadata || '{}'),\n          default_contract_id: contractId || agentConfig.default_contract_id\n        }\n\n        // Auto-generate UUID graph ID if none provided\n        const targetGraphId = graphId || crypto.randomUUID()\n\n        // Build task with graph context so the agent knows which graph to target\n        let enrichedTask = `${task}\\n\\n[Target graph ID: ${targetGraphId}] \u2014 Use this exact graphId when calling create_graph and create_html_from_template.`\n\n        // Execute agent\n        const result = await executeAgent(config, enrichedTask, userId, env)\n\n        return new Response(JSON.stringify(result), {\n          headers: corsHeaders\n        })\n      }\n\n      // GET /layout?contractId=xxx - Get saved node layout\n      if (pathname === '/layout' && request.method === 'GET') {\n        const contractId = url.searchParams.get('contractId')\n        if (!contractId) {\n          return new Response(JSON.stringify({ error: 'contractId required' }), {\n            status: 400, headers: corsHeaders\n          })\n        }\n        const row = await env.DB.prepare(\n          'SELECT layout FROM agent_contracts WHERE id = ?1'\n        ).bind(contractId).first()\n        return new Response(JSON.stringify({\n          contractId,\n          layout: row?.layout ? JSON.parse(row.layout) : null\n        }), { headers: corsHeaders })\n      }\n\n      // PUT /layout - Save node layout positions\n      if (pathname === '/layout' && request.method === 'PUT') {\n        const body = await request.json()\n        const { contractId, layout } = body\n        if (!contractId || !layout) {\n          return new Response(JSON.stringify({ error: 'contractId and layout required' }), {\n            status: 400, headers: corsHeaders\n          })\n        }\n        await env.DB.prepare(\n          'UPDATE agent_contracts SET layout = ?1, updated_at = datetime(\\'now\\') WHERE id = ?2'\n        ).bind(JSON.stringify(layout), contractId).run()\n        return new Response(JSON.stringify({\n          contractId, saved: true\n        }), { headers: corsHeaders })\n      }\n\n      // POST /build-html-page \u2014 Create html-node directly (no agent needed)\n      if (pathname === '/build-html-page' && request.method === 'POST') {\n        const body = await request.json()\n        const { graphId, title, userId } = body\n\n        if (!graphId || !title || !userId) {\n          return new Response(JSON.stringify({ error: 'graphId, title, and userId required' }), {\n            status: 400, headers: corsHeaders\n          })\n        }\n\n        try {\n          const result = await executeCreateHtmlFromTemplate({\n            graphId,\n            title,\n            description: body.description || '',\n            footerText: body.footerText || '',\n            sections: [],\n            headerImage: null,\n          }, env)\n\n          return new Response(JSON.stringify(result), { headers: corsHeaders })\n        } catch (err) {\n          return new Response(JSON.stringify({ error: err.message }), {\n            status: 500, headers: corsHeaders\n          })\n        }\n      }\n\n      // GET /template-version \u2014 Return current template version\n      if (pathname === '/template-version' && request.method === 'GET') {\n        const versionMatch = EDITABLE_HTML_TEMPLATE.match(/<meta\\s+name=\"template-version\"\\s+content=\"([^\"]+)\"/)\n        return new Response(JSON.stringify({\n          version: versionMatch ? versionMatch[1] : 'unknown'\n        }), { headers: corsHeaders })\n      }\n\n      // POST /upgrade-html-node \u2014 Upgrade existing html-node to latest template\n      if (pathname === '/upgrade-html-node' && request.method === 'POST') {\n        const body = await request.json()\n        const { graphId, nodeId } = body\n\n        if (!graphId || !nodeId) {\n          return new Response(JSON.stringify({ error: 'graphId and nodeId required' }), {\n            status: 400, headers: corsHeaders\n          })\n        }\n\n        try {\n          // Fetch the graph\n          const getRes = await env.KG_WORKER.fetch(\n            `https://knowledge-graph-worker/getknowgraph?id=${encodeURIComponent(graphId)}`\n          )\n          if (!getRes.ok) throw new Error('Graph not found')\n          const graphData = await getRes.json()\n\n          // Find the html-node\n          const nodeIndex = graphData.nodes.findIndex(n => String(n.id) === String(nodeId))\n          if (nodeIndex === -1) throw new Error('Node not found')\n          const oldNode = graphData.nodes[nodeIndex]\n          if (oldNode.type !== 'html-node') throw new Error('Node is not an html-node')\n\n          // Extract metadata from old HTML\n          const oldHtml = oldNode.info || ''\n          const titleMatch = oldHtml.match(/<title>([^<]*)<\\/title>/)\n          const descMatch = oldHtml.match(/<p\\s+class=\"muted[^\"]*\"[^>]*>([^<]*)<\\/p>/)\n          const footerMatch = oldHtml.match(/footer-text[^>]*>([^<]*)</)\n          const oldVersionMatch = oldHtml.match(/<meta\\s+name=\"template-version\"\\s+content=\"([^\"]+)\"/)\n\n          const title = titleMatch ? titleMatch[1] : oldNode.label || 'Untitled'\n          const description = descMatch ? descMatch[1] : ''\n          const footerText = footerMatch ? footerMatch[1] : ''\n          const oldVersion = oldVersionMatch ? oldVersionMatch[1] : 'none'\n\n          // Generate new HTML from latest template\n          let newHtml = EDITABLE_HTML_TEMPLATE\n          newHtml = newHtml.replaceAll('{{TITLE}}', title)\n          newHtml = newHtml.replaceAll('{{DESCRIPTION}}', description)\n          newHtml = newHtml.replaceAll('{{FOOTER_TEXT}}', footerText)\n          newHtml = newHtml.replaceAll('{{GRAPH_ID_DEFAULT}}', graphId)\n\n          // Get new version\n          const newVersionMatch = newHtml.match(/<meta\\s+name=\"template-version\"\\s+content=\"([^\"]+)\"/)\n          const newVersion = newVersionMatch ? newVersionMatch[1] : 'unknown'\n\n          // Update the node in the graph\n          graphData.nodes[nodeIndex] = {\n            ...oldNode,\n            info: newHtml,\n            updatedAt: new Date().toISOString()\n          }\n\n          // Save the graph\n          const saveRes = await env.KG_WORKER.fetch('https://knowledge-graph-worker/saveGraphWithHistory', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              graphId,\n              nodes: graphData.nodes,\n              edges: graphData.edges || [],\n              metadata: graphData.metadata || {}\n            })\n          })\n\n          if (!saveRes.ok) throw new Error('Failed to save upgraded graph')\n\n          return new Response(JSON.stringify({\n            success: true,\n            nodeId,\n            oldVersion,\n            newVersion,\n            title,\n            htmlSize: newHtml.length,\n            message: `Upgraded from v${oldVersion} to v${newVersion}`\n          }), { headers: corsHeaders })\n        } catch (err) {\n          return new Response(JSON.stringify({ error: err.message }), {\n            status: 500, headers: corsHeaders\n          })\n        }\n      }\n\n      // GET /health - Health check\n      if (pathname === '/health' && request.method === 'GET') {\n        return new Response(JSON.stringify({\n          status: 'healthy',\n          worker: 'agent-worker',\n          timestamp: new Date().toISOString()\n        }), {\n          headers: corsHeaders\n        })\n      }\n\n      return new Response(JSON.stringify({\n        error: 'Not found',\n        available_endpoints: ['/execute', '/layout', '/build-html-page', '/template-version', '/upgrade-html-node', '/health']\n      }), {\n        status: 404,\n        headers: corsHeaders\n      })\n\n    } catch (error) {\n      return new Response(JSON.stringify({\n        error: error.message,\n        stack: error.stack\n      }), {\n        status: 500,\n        headers: corsHeaders\n      })\n    }\n  }\n}\n"],
  "mappings": ";;;;AAaO,IAAM,yBAAyB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA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",
  "names": []
}
